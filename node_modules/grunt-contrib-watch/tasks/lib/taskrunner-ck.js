/*
 * grunt-contrib-watch
 * http://gruntjs.com/
 *
 * Copyright (c) 2013 "Cowboy" Ben Alman, contributors
 * Licensed under the MIT license.
 */"use strict";var path=require("path"),EE=require("events").EventEmitter,util=require("util"),reloadTargets=[];module.exports=function(e){function r(){EE.call(this);this.name="watch";this.options={};this.done=function(){};this.targets=Object.create(null);this.queue=[];this.running=!1;this.nospawn=!1;this.reload=!1;this.nameArgs=[];this.changedFiles=Object.create(null)}var t=require("./taskrun")(e),n=require("./livereload")(e);util.inherits(r,EE);r.prototype.init=function(r,i,s){var o=this;o.name=r||e.task.current.name||"watch";o.options=o._options(e.config([o.name,"options"])||{},i||{});o.reload=!1;o.nameArgs=e.task.current.nameArgs?e.task.current.nameArgs:o.name;o.done=s||e.task.current.async();var u=e.config([o.name,"options","livereload"]);if(o.options.target&&u){var a=e.config([o.name,o.options.target,"options","livereload"]);a&&(u=!1)}u&&(o.livereload=n(u));var f=o._getTargets(o.name);if(o.running)o.complete();else if(reloadTargets.length>0){o.queue=reloadTargets;reloadTargets=[];o.run()}else{o.queue=f.filter(function(e){return e.options.atBegin===!0&&e.tasks.length>0}).map(function(e){return e.name});o.queue.length>0&&o.run()}return f};r.prototype._getTargets=function(n){var r=this;e.task.current.requiresConfig(n);var i=e.config(n),s=r.options.target?r.options.target:!1,o=(s?[s]:Object.keys(i)).filter(function(e){return e==="options"?!1:typeof i[e]!="string"&&!Array.isArray(i[e])}).map(function(t){e.task.current.requiresConfig([n,t,"files"]);var i=e.config([n,t]);i.name=t;i.options=r._options(i.options||{},r.options);r.add(i);return i},r);if(typeof i.files=="string"||Array.isArray(i.files)){var u={files:i.files,tasks:i.tasks,name:"default",options:r._options(i.options||{},r.options)};o.push(u);r.add(u)}return o};r.prototype._options=function(){var n=Array.prototype.slice.call(arguments).concat({cwd:process.cwd(),cliArgs:e.util._.without.apply(null,[[].slice.call(process.argv,2)].concat(e.cli.tasks)),interrupt:!1,nospawn:!1,spawn:!0,atBegin:!1,event:["all"],target:null});return e.util._.defaults.apply(e.util._,n)};r.prototype.run=e.util._.debounce(function(){var n=this;if(n.queue.length<1){n.running=!1;return}n.options=n._options(e.config([n.name,"options"])||{},n.options);if(n.running===!0){var r=!0;n.queue.forEach(function(e){var t=n.targets[e];if(t&&t.options.interrupt!==!0){r=!1;return!1}});if(r!==!0)return;n.interrupt()}if(n.reload)return n.reloadTask();n.emit("start");n.running=!0;var i=!0;e.util.async.forEachSeries(n.queue,function(t,r){var s=n.targets[t];if(!s)return r();s.options=n._options(e.config([n.name,t,"options"])||{},s.options,n.options);if(s.options.spawn===!1||s.options.nospawn===!0)i=!1;s.run(r)},function(){if(i)n.complete();else{e.task.mark().run(n.nameArgs);n.done()}})},250);r.prototype.add=function(i){if(!this.targets[i.name||0]){var s=new t(i),o=e.config([this.name,i.name||0,"options","livereload"]);o?s.livereload=n(o):this.livereload&&o!==!1&&(s.livereload=this.livereload);return this.targets[s.name]=s}return!1};r.prototype.complete=function(){var t=this;if(t.running===!1)return;t.running=!1;var n=0;for(var r=0,i=t.queue.length;r<i;++r){var s=t.queue[r],o=t.targets[s];if(!o)return;if(o.startedAt!==!1){n+=o.complete();t.queue.splice(r--,1);i--;o.options.livereload&&o.tasks.length<1&&(n+=1e-4)}}var u=n>0?Number(n/1e3):0;t.changedFiles=Object.create(null);t.emit("end",u)};r.prototype._completeQueue=function(){var t=this;t.queue.forEach(function(e){var n=t.targets[e];if(!n)return;n.complete()})};r.prototype.interrupt=function(){var n=this;n._completeQueue();e.task.clearQueue();n.emit("interrupt")};r.prototype.forever=function(){function r(){n._completeQueue();e.task.clearQueue();e.task.run(n.nameArgs);n.running=!1}var n=this;e.warn=e.fail.warn=function(t){var n=typeof t=="string"?t:t.message;e.log.writeln(("Warning: "+n).yellow);e.option("force")||r()};e.fatal=e.fail.fatal=function(t){var n=typeof t=="string"?t:t.message;e.log.writeln(("Fatal error: "+n).red);r()}};r.prototype.clearRequireCache=function(){var t=typeof arguments[0]!="string"?arguments[0]:e.util.toArray(arguments);t.forEach(function(t){var n=path.resolve(t);if(require.cache[n]){e.verbose.write('Clearing require cache for "'+t+'" file...').ok();delete require.cache[n]}})};r.prototype.reloadTask=function(){var t=this;reloadTargets=t.queue;t.emit("reload",reloadTargets);e.task.init([t.name]);t._completeQueue();e.task.run(t.nameArgs);t.done()};return new r};