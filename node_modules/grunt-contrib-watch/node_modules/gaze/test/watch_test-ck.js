"use strict";function cleanUp(e){["sub/tmp.js","sub/tmp","sub/renamed.js","added.js","nested/added.js","nested/.tmp","nested/sub/added.js"].forEach(function(e){var t=path.resolve(__dirname,"fixtures",e);fs.existsSync(t)&&fs.unlinkSync(t)});grunt.file.delete(path.resolve(__dirname,"fixtures","new_dir"));e()}var gaze=require("../lib/gaze.js"),grunt=require("grunt"),path=require("path"),fs=require("fs");exports.watch={setUp:function(e){process.chdir(path.resolve(__dirname,"fixtures"));cleanUp(e)},tearDown:cleanUp,remove:function(e){e.expect(2);gaze("**/*",function(){this.remove(path.resolve(__dirname,"fixtures","sub","two.js"));this.remove(path.resolve(__dirname,"fixtures"));var t=this.relative(null,!0);e.deepEqual(t["sub/"],["one.js"]);e.notDeepEqual(t["."],["one.js"]);this.close();e.done()})},changed:function(e){e.expect(1);gaze("**/*",function(t,n){n.on("changed",function(t){var r=path.relative(process.cwd(),t);e.equal(path.join("sub","one.js"),r);n.close()});this.on("added",function(){e.ok(!1,"added event should not have emitted.")});this.on("deleted",function(){e.ok(!1,"deleted event should not have emitted.")});fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","one.js"),"var one = true;");n.on("end",e.done)})},added:function(e){e.expect(1);gaze("**/*",function(t,n){n.on("added",function(t){var r=path.relative(process.cwd(),t);e.equal(path.join("sub","tmp.js"),r);n.close()});this.on("changed",function(){e.ok(!1,"changed event should not have emitted.")});this.on("deleted",function(){e.ok(!1,"deleted event should not have emitted.")});fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","tmp.js"),"var tmp = true;");n.on("end",e.done)})},dontAddUnmatchedFiles:function(e){e.expect(2);gaze("**/*.js",function(t,n){setTimeout(function(){e.ok(!0,"Ended without adding a file.");n.close()},1e3);this.on("added",function(t){e.equal(path.relative(process.cwd(),t),path.join("sub","tmp.js"))});fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","tmp"),"Dont add me!");fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","tmp.js"),"add me!");n.on("end",e.done)})},dontAddMatchedDirectoriesThatArentReallyAdded:function(e){e.expect(1);gaze("**/*",function(t,n){setTimeout(function(){e.ok(!0,"Ended without adding a file.");n.close()},1e3);this.on("added",function(t){e.notEqual(path.relative(process.cwd(),t),path.join("nested","sub2"))});fs.writeFileSync(path.resolve(__dirname,"fixtures","nested",".tmp"),"Wake up!");n.on("end",e.done)})},deleted:function(e){e.expect(1);var t=path.resolve(__dirname,"fixtures","sub","deleted.js");fs.writeFileSync(t,"var tmp = true;");gaze("**/*",function(n,r){r.on("deleted",function(t){e.equal(path.join("sub","deleted.js"),path.relative(process.cwd(),t));r.close()});this.on("changed",function(){e.ok(!1,"changed event should not have emitted.")});this.on("added",function(){e.ok(!1,"added event should not have emitted.")});fs.unlinkSync(t);r.on("end",e.done)})},dontEmitTwice:function(e){e.expect(2);gaze("**/*",function(t,n){n.on("all",function(t,r){var i=path.relative(process.cwd(),r);e.equal(path.join("sub","one.js"),i);e.equal(t,"changed");fs.readFileSync(path.resolve(__dirname,"fixtures","sub","one.js"));setTimeout(function(){fs.readFileSync(path.resolve(__dirname,"fixtures","sub","one.js"))},1e3);setTimeout(function(){n.close()},5e3)});setTimeout(function(){fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","one.js"),"var one = true;")},1e3);n.on("end",e.done)})},emitTwice:function(e){e.expect(2);var t=0;gaze("**/*",function(n,r){r.on("all",function(n,i){e.equal(n,"changed");t++;setTimeout(function(){t<2?fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","one.js"),"var one = true;"):r.close()},1e3)});setTimeout(function(){fs.writeFileSync(path.resolve(__dirname,"fixtures","sub","one.js"),"var one = true;")},1e3);r.on("end",e.done)})},nonExistent:function(e){e.expect(1);gaze("non/existent/**/*",function(t,n){e.ok(!0);e.done()})},differentCWD:function(e){e.expect(1);var t=path.resolve(__dirname,"fixtures","sub");gaze("two.js",{cwd:t},function(n,r){r.on("changed",function(t){e.deepEqual(this.relative(),{".":["two.js"]});r.close()});fs.writeFileSync(path.resolve(t,"two.js"),"var two = true;");r.on("end",e.done)})},addedEmitInSubFolders:function(e){e.expect(4);var t=[{pattern:"**/*",file:path.resolve(__dirname,"fixtures","nested","sub","added.js")},{pattern:"**/*",file:path.resolve(__dirname,"fixtures","added.js")},{pattern:"nested/**/*",file:path.resolve(__dirname,"fixtures","nested","added.js")},{pattern:"nested/sub/*.js",file:path.resolve(__dirname,"fixtures","nested","sub","added.js")}];grunt.util.async.forEachSeries(t,function(t,n){new gaze.Gaze(t.pattern,function(r,i){i.on("added",function(t){e.equal("added.js",path.basename(t));fs.unlinkSync(t);i.close();n()});i.on("changed",function(){e.ok(!1,"changed event should not have emitted.")});i.on("deleted",function(){e.ok(!1,"deleted event should not have emitted.")});fs.writeFileSync(t.file,"var added = true;")})},function(){e.done()})},multipleWatchersSimultaneously:function(e){function o(){n++;n>1&&fs.writeFileSync(path.resolve(r,"one.js"),"var one = true;")}function u(){t++;if(t>1){clearTimeout(s);i.forEach(function(e){e.close()});e.done()}}function a(t){e.equal(path.join("sub","one.js"),path.relative(process.cwd(),t));u()}e.expect(2);var t=0,n=0,r=path.resolve(__dirname,"fixtures","sub"),i=[],s=setTimeout(function(){e.ok(!1,"Only "+t+" of "+n+" watchers fired.");e.done();i.forEach(function(e){e.close()})},1e3);for(var f=0;f<2;f++){i[f]=new gaze.Gaze("sub/one.js");i[f].on("changed",a);i[f].on("ready",o)}},mkdirThenAddFile:function(e){e.expect(2);var t=["new_dir","new_dir/other.js"];gaze("**/*.js",function(n,r){r.on("all",function(n,i){var s=t.shift();e.equal(path.relative(process.cwd(),i),s);t.length===1&&setTimeout(function(){fs.writeFileSync("new_dir/dontmatch.txt","");setTimeout(function(){fs.writeFileSync("new_dir/other.js","")},1e3)},1e3);t.length<1&&r.close()});fs.mkdirSync("new_dir");r.on("end",e.done)})},mkdirThenAddFileWithGruntFileWrite:function(e){e.expect(3);var t=["new_dir","new_dir/tmp.js","new_dir/other.js"];gaze("**/*.js",function(n,r){r.on("all",function(n,i){var s=t.shift();e.equal(path.relative(process.cwd(),i),s);t.length===1&&setTimeout(function(){fs.writeFileSync("new_dir/dontmatch.txt","");setTimeout(function(){fs.writeFileSync("new_dir/other.js","")},1e3)},1e3);t.length<1&&r.close()});grunt.file.write("new_dir/tmp.js","");r.on("end",e.done)})}};