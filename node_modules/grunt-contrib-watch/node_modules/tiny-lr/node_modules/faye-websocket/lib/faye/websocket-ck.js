// API and protocol references:
// 
// * http://dev.w3.org/html5/websockets/
// * http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-eventtarget
// * http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-event
// * http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-75
// * http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76
// * http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-17
var Draft75Parser=require("./websocket/draft75_parser"),Draft76Parser=require("./websocket/draft76_parser"),HybiParser=require("./websocket/hybi_parser"),API=require("./websocket/api"),Event=require("./websocket/api/event"),getParser=function(e){var t=e.headers;return t["sec-websocket-version"]?HybiParser:t["sec-websocket-key1"]&&t["sec-websocket-key2"]?Draft76Parser:Draft75Parser},isSecureConnection=function(e){return e.headers["x-forwarded-proto"]?e.headers["x-forwarded-proto"]==="https":e.connection&&e.connection.authorized!==undefined||e.socket&&e.socket.secure},WebSocket=function(e,t,n,r,i){this.request=e;this._stream=e.socket;this._ping=i&&i.ping;this._pingId=0;var s=isSecureConnection(e)?"wss:":"ws:";this.url=s+"//"+e.headers.host+e.url;this.readyState=API.CONNECTING;this.bufferedAmount=0;var o=getParser(e);this._parser=new o(this,{protocols:r});var u=this;this._sendBuffer=[];process.nextTick(function(){u._open()});var a=this._parser.handshakeResponse(n);this._parser.isOpen()&&(this.readyState=API.OPEN);this._ping&&(this._pingLoop=setInterval(function(){u._pingId+=1;u.ping(u._pingId.toString())},this._ping*1e3));this.protocol=this._parser.protocol||"";this.version=this._parser.getVersion();if(!this._stream||!this._stream.writable)return;this._stream.setTimeout(0);this._stream.setNoDelay(!0);try{this._stream.write(a,"binary")}catch(f){}this._stream.addListener("data",function(e){var t=u._parser.parse(e);if(!t)return;try{u._stream.write(t,"binary")}catch(n){}u._open()});["close","end","error"].forEach(function(e){u._stream.addListener(e,function(){u.close(1006,"",!1)})})};WebSocket.prototype.ping=function(e,t,n){return this._parser.ping?this._parser.ping(e,t,n):!1};for(var key in API)WebSocket.prototype[key]=API[key];WebSocket.WebSocket=WebSocket;WebSocket.Client=require("./websocket/client");WebSocket.EventSource=require("./eventsource");module.exports=WebSocket;