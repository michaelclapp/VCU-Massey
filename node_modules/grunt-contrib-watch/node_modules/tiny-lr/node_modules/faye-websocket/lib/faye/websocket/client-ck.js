var net=require("net"),tls=require("tls"),HybiParser=require("./hybi_parser"),API=require("./api"),Event=require("./api/event"),Client=function(e,t,n){this.url=e;this._uri=require("url").parse(e);this.protocol="";this.readyState=API.CONNECTING;this.bufferedAmount=0;var r=this._uri.protocol==="wss:",i=this,s=function(){i._onConnect()},o={};n&&n.verify===!1&&(o.rejectUnauthorized=!1);var u=r?tls.connect(this._uri.port||443,this._uri.hostname,o,s):net.createConnection(this._uri.port||80,this._uri.hostname);this._parser=new HybiParser(this,{masking:!0,protocols:t});this._stream=u;this._stream.setTimeout(0);this._stream.setNoDelay(!0);r||u.addListener("connect",s);u.addListener("data",function(e){i._onData(e)});["close","end","error"].forEach(function(e){u.addListener(e,function(){i.close(1006,"",!1)})})};Client.prototype._onConnect=function(){this._handshake=this._parser.createHandshake(this._uri,this._stream);this._message=[];try{this._stream.write(this._handshake.requestData(),"binary")}catch(e){}};Client.prototype._onData=function(e){switch(this.readyState){case API.CONNECTING:var t=this._handshake.parse(e);for(var n=0,r=t.length;n<r;n++)this._message.push(t[n]);if(!this._handshake.isComplete())return;if(this._handshake.isValid()){this.protocol=this._handshake.protocol||"";this.readyState=API.OPEN;var i=new Event("open");i.initEvent("open",!1,!1);this.dispatchEvent(i);this._parser.parse(this._message)}else{this.readyState=API.CLOSED;var i=new Event("close",{code:1006,reason:""});i.initEvent("close",!1,!1);this.dispatchEvent(i)}break;case API.OPEN:case API.CLOSING:this._parser.parse(e)}};for(var key in API)Client.prototype[key]=API[key];module.exports=Client;