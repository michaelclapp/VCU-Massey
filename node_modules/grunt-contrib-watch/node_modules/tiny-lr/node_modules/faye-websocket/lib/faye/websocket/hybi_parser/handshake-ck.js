var crypto=require("crypto"),Handshake=function(e,t){this._uri=e;this._protocols=t;var n=new Buffer(16),r=16;while(r--)n[r]=Math.floor(Math.random()*256);this._key=n.toString("base64");var i=crypto.createHash("sha1");i.update(this._key+Handshake.GUID);this._accept=i.digest("base64");var s=process.binding("http_parser").HTTPParser,o=new s(s.RESPONSE||"response"),u=null,a=this;this._nodeVersion=s.RESPONSE?6:4;this._complete=!1;this._headers={};this._parser=o;o.onHeaderField=function(e,t,n){u=e.toString("utf8",t,t+n)};o.onHeaderValue=function(e,t,n){a._headers[u]=e.toString("utf8",t,t+n)};o.onHeadersComplete=function(e){a._status=e.statusCode;var t=e.headers;if(!t)return;for(var n=0,r=t.length;n<r;n+=2)a._headers[t[n]]=t[n+1]};o.onMessageComplete=function(){a._complete=!0}};Handshake.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";Handshake.prototype.requestData=function(){var e=this._uri,t=["GET "+(e.pathname||"/")+(e.search||"")+" HTTP/1.1","Host: "+e.hostname+(e.port?":"+e.port:""),"Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: "+this._key,"Sec-WebSocket-Version: 13"];this._protocols&&t.push("Sec-WebSocket-Protocol: "+this._protocols.join(", "));return new Buffer(t.concat("","").join("\r\n"),"utf8")};Handshake.prototype.parse=function(e){var t=this._parser.execute(e,0,e.length),n=this._nodeVersion<6?1:0;return t===e.length?[]:e.slice(t+n)};Handshake.prototype.isComplete=function(){return this._complete};Handshake.prototype.isValid=function(){if(this._status!==101)return!1;var e=this._headers.Upgrade,t=this._headers.Connection,n=this._headers["Sec-WebSocket-Protocol"];this.protocol=this._protocols&&this._protocols.indexOf(n)>=0?n:null;return e&&/^websocket$/i.test(e)&&t&&t.split(/\s*,\s*/).indexOf("Upgrade")>=0&&(!this._protocols&&!n||this.protocol)&&this._headers["Sec-WebSocket-Accept"]===this._accept};module.exports=Handshake;