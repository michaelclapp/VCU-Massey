var EventTarget=require("./api/event_target"),Event=require("./api/event"),API={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,_open:function(){if(this._parser&&!this._parser.isOpen())return;this.readyState=API.OPEN;var e=this._sendBuffer||[],t;while(t=e.shift())this.send.apply(this,t);var n=new Event("open");n.initEvent("open",!1,!1);this.dispatchEvent(n)},receive:function(e){if(this.readyState!==API.OPEN)return!1;var t=new Event("message");t.initEvent("message",!1,!1);t.data=e;this.dispatchEvent(t)},send:function(e,t,n){if(this.readyState===API.CONNECTING){if(this._sendBuffer){this._sendBuffer.push(arguments);return!0}throw new Error("Cannot call send(), socket is not open yet")}if(this.readyState===API.CLOSED)return!1;e instanceof Buffer||(e=String(e));var r=this._parser.frame(e,t,n);try{this._stream.write(r,"binary");return!0}catch(i){return!1}},close:function(e,t,n){if(this.readyState===API.CLOSED)return;if(this.readyState===API.CLOSING&&n!==!1)return;var r=function(){this.readyState=API.CLOSED;this._pingLoop&&clearInterval(this._pingLoop);this._stream&&this._stream.end();var n=new Event("close",{code:e||1e3,reason:t||""});n.initEvent("close",!1,!1);this.dispatchEvent(n)};if(this.readyState===API.CONNECTING)return r.call(this);this.readyState=API.CLOSING;if(n===!1){this._parser.close&&this._parser.close(e,t);r.call(this)}else this._parser.close?this._parser.close(e,t,r,this):r.call(this)}};for(var key in EventTarget)API[key]=EventTarget[key];module.exports=API;