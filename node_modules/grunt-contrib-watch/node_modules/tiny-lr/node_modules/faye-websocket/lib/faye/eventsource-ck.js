var API=require("./websocket/api"),Event=require("./websocket/api/event"),isSecureConnection=function(e){return e.headers["x-forwarded-proto"]?e.headers["x-forwarded-proto"]==="https":e.connection&&e.connection.authorized!==undefined||e.socket&&e.socket.secure},EventSource=function(e,t,n){n=n||{};this._request=e;this._response=t;this._stream=t.socket;this._ping=n.ping||this.DEFAULT_PING;this._retry=n.retry||this.DEFAULT_RETRY;var r=isSecureConnection(e)?"https:":"http:";this.url=r+"//"+e.headers.host+e.url;this.lastEventId=e.headers["last-event-id"]||"";var i=this;this.readyState=API.CONNECTING;this._sendBuffer=[];process.nextTick(function(){i._open()});var s="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n\r\n\r\nretry: "+Math.floor(this._retry*1e3)+"\r\n\r\n";this.readyState=API.OPEN;this._ping&&(this._pingLoop=setInterval(function(){i.ping()},this._ping*1e3));if(!this._stream||!this._stream.writable)return;this._stream.setTimeout(0);this._stream.setNoDelay(!0);try{this._stream.write(s,"utf8")}catch(o){}["close","end","error"].forEach(function(e){i._stream.addListener(e,function(){i.close()})})};EventSource.isEventSource=function(e){var t=(e.headers.accept||"").split(/\s*,\s*/);return t.indexOf("text/event-stream")>=0};var instance={DEFAULT_PING:10,DEFAULT_RETRY:5,send:function(e,t){if(this.readyState!==API.OPEN)return!1;e=String(e).replace(/(\r\n|\r|\n)/g,"$1data: ");t=t||{};var n="";t.event&&(n+="event: "+t.event+"\r\n");t.id&&(n+="id: "+t.id+"\r\n");n+="data: "+e+"\r\n\r\n";try{this._stream.write(n,"utf8");return!0}catch(r){return!1}},ping:function(){try{this._stream.write(":\r\n\r\n","utf8");return!0}catch(e){return!1}},close:function(){if(this.readyState===API.CLOSING||this.readyState===API.CLOSED)return;this.readyState=API.CLOSED;clearInterval(this._pingLoop);this._response.end();var e=new Event("close");e.initEvent("close",!1,!1);this.dispatchEvent(e)}};for(var key in API)EventSource.prototype[key]=API[key];for(var key in instance)EventSource.prototype[key]=instance[key];module.exports=EventSource;