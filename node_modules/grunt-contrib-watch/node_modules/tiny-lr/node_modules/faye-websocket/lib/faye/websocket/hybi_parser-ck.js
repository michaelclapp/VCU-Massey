var crypto=require("crypto"),Handshake=require("./hybi_parser/handshake"),Reader=require("./hybi_parser/stream_reader"),HybiParser=function(e,t){this._reset();this._socket=e;this._reader=new Reader;this._stage=0;this._masking=t&&t.masking;this._protocols=t&&t.protocols;this._pingCallbacks={};typeof this._protocols=="string"&&(this._protocols=this._protocols.split(/\s*,\s*/))};HybiParser.mask=function(e,t,n){if(t.length===0)return e;n=n||0;for(var r=0,i=e.length-n;r<i;r++)e[n+r]=e[n+r]^t[r%4];return e};var instance={BYTE:255,FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},FRAGMENTED_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,getVersion:function(){var e=this._socket.request.headers["sec-websocket-version"];return"hybi-"+e},handshakeResponse:function(){var e=this._socket.request.headers["sec-websocket-key"];if(!e)return null;var t=crypto.createHash("sha1");t.update(e+Handshake.GUID);var n=t.digest("base64"),r=this._socket.request.headers["sec-websocket-protocol"],i=this._protocols,s,o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+n];if(r!==undefined&&i!==undefined){typeof r=="string"&&(r=r.split(/\s*,\s*/));s=r.filter(function(e){return i.indexOf(e)>=0})[0];if(s){this.protocol=s;o.push("Sec-WebSocket-Protocol: "+s)}}return new Buffer(o.concat("","").join("\r\n"),"utf8")},isOpen:function(){return!0},createHandshake:function(e){return new Handshake(e,this._protocols)},parse:function(e){this._reader.put(e);var t=!0;while(t)switch(this._stage){case 0:t=this._reader.read(1);t&&this._parseOpcode(t[0]);break;case 1:t=this._reader.read(1);t&&this._parseLength(t[0]);break;case 2:t=this._reader.read(this._lengthSize);t&&this._parseExtendedLength(t);break;case 3:t=this._reader.read(4);if(t){this._mask=t;this._stage=4}break;case 4:t=this._reader.read(this._length);if(t){this._payload=t;this._emitFrame();this._stage=0}}},_parseOpcode:function(e){var t=[this.RSV1,this.RSV2,this.RSV3].filter(function(t){return(e&t)===t},this);if(t.length>0)return this._socket.close(this.ERRORS.protocol_error,null,!1);this._final=(e&this.FIN)===this.FIN;this._opcode=e&this.OPCODE;this._mask=[];this._payload=[];var n=!1;for(var r in this.OPCODES)this.OPCODES[r]===this._opcode&&(n=!0);if(!n)return this._socket.close(this.ERRORS.protocol_error,null,!1);if(this.FRAGMENTED_OPCODES.indexOf(this._opcode)<0&&!this._final)return this._socket.close(this.ERRORS.protocol_error,null,!1);if(this._mode&&this.OPENING_OPCODES.indexOf(this._opcode)>=0)return this._socket.close(this.ERRORS.protocol_error,null,!1);this._stage=1},_parseLength:function(e){this._masked=(e&this.MASK)===this.MASK;this._length=e&this.LENGTH;if(this._length>=0&&this._length<=125)this._stage=this._masked?3:4;else{this._lengthBuffer=[];this._lengthSize=this._length===126?2:8;this._stage=2}},_parseExtendedLength:function(e){this._length=this._getInteger(e);this._stage=this._masked?3:4},frame:function(e,t,n){if(this._closed)return null;var r=typeof e=="string",i=this.OPCODES[t||(r?"text":"binary")],s=r?new Buffer(e,"utf8"):e,o=n?2:0,u=s.length+o,a=u<=125?2:u<=65535?4:10,f=a+(this._masking?4:0),l=this._masking?this.MASK:0,c=new Buffer(u+f),h=this.BYTE,p,d;c[0]=this.FIN|i;if(u<=125)c[1]=l|u;else if(u<=65535){c[1]=l|126;c[2]=Math.floor(u/256);c[3]=u&h}else{c[1]=l|127;c[2]=Math.floor(u/Math.pow(2,56))&h;c[3]=Math.floor(u/Math.pow(2,48))&h;c[4]=Math.floor(u/Math.pow(2,40))&h;c[5]=Math.floor(u/Math.pow(2,32))&h;c[6]=Math.floor(u/Math.pow(2,24))&h;c[7]=Math.floor(u/Math.pow(2,16))&h;c[8]=Math.floor(u/Math.pow(2,8))&h;c[9]=u&h}if(n){c[f]=Math.floor(n/256)&h;c[f+1]=n&h}s.copy(c,f+o);if(this._masking){p=[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)];(new Buffer(p)).copy(c,a);HybiParser.mask(c,p,f)}return c},ping:function(e,t,n){e=e||"";t&&(this._pingCallbacks[e]=[t,n]);return this._socket.send(e,"ping")},close:function(e,t,n,r){if(this._closed)return;n&&(this._closingCallback=[n,r]);this._socket.send(t||"","close",e||this.ERRORS.normal_closure);this._closed=!0},buffer:function(e){for(var t=0,n=e.length;t<n;t++)this._buffer.push(e[t])},_emitFrame:function(){var e=HybiParser.mask(this._payload,this._mask),t=this._opcode;if(t===this.OPCODES.continuation){if(!this._mode)return this._socket.close(this.ERRORS.protocol_error,null,!1);this.buffer(e);if(this._final){var n=new Buffer(this._buffer);this._mode==="text"&&(n=this._encode(n));this._reset();n!==null?this._socket.receive(n):this._socket.close(this.ERRORS.encoding_error,null,!1)}}else if(t===this.OPCODES.text)if(this._final){var n=this._encode(e);n!==null?this._socket.receive(n):this._socket.close(this.ERRORS.encoding_error,null,!1)}else{this._mode="text";this.buffer(e)}else if(t===this.OPCODES.binary)if(this._final)this._socket.receive(e);else{this._mode="binary";this.buffer(e)}else if(t===this.OPCODES.close){var r=e.length>=2?256*e[0]+e[1]:null,i=e.length>2?this._encode(e.slice(2)):null;e.length!==0&&!(r!==null&&r>=3e3&&r<5e3)&&this.ERROR_CODES.indexOf(r)<0&&(r=this.ERRORS.protocol_error);if(e.length>125||e.length>2&&!i)r=this.ERRORS.protocol_error;this._socket.close(r,e.length>2?i:null,!1);this._closingCallback&&this._closingCallback[0].call(this._closingCallback[1])}else if(t===this.OPCODES.ping){if(e.length>125)return this._socket.close(this.ERRORS.protocol_error,null,!1);this._socket.send(e,"pong")}else if(t===this.OPCODES.pong){var s=this._pingCallbacks,n=this._encode(e),o=s[n];delete s[n];o&&o[0].call(o[1])}},_reset:function(){this._mode=null;this._buffer=[]},_encode:function(e){try{var t=e.toString("binary",0,e.length);if(!this.UTF8_MATCH.test(t))return null}catch(n){}return e.toString("utf8",0,e.length)},_getInteger:function(e){var t=0;for(var n=0,r=e.length;n<r;n++)t+=e[n]<<8*(r-1-n);return t}};for(var key in instance)HybiParser.prototype[key]=instance[key];module.exports=HybiParser;