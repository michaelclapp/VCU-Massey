var crypto=require("crypto"),Draft75Parser=require("./draft75_parser"),Draft76Parser=function(){Draft75Parser.apply(this,arguments)},bridge=function(){};bridge.prototype=Draft75Parser.prototype;Draft76Parser.prototype=new bridge;var numberFromKey=function(e){return parseInt(e.match(/[0-9]/g).join(""),10)},spacesInKey=function(e){return e.match(/ /g).length},bigEndian=function(e){var t="";[24,16,8,0].forEach(function(n){t+=String.fromCharCode(e>>n&255)});return t};Draft76Parser.prototype.getVersion=function(){return"hixie-76"};Draft76Parser.prototype.handshakeResponse=function(e){var t=this._socket.request,n,r=new Buffer("HTTP/1.1 101 Web Socket Protocol Handshake\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\nSec-WebSocket-Origin: "+t.headers.origin+"\r\n"+"Sec-WebSocket-Location: "+this._socket.url+"\r\n\r\n","binary"),i=this.handshakeSignature(e);if(i){n=new Buffer(r.length+i.length);r.copy(n,0);i.copy(n,r.length);r=n}return r};Draft76Parser.prototype.isOpen=function(){return!!this._handshakeComplete};Draft76Parser.prototype.handshakeSignature=function(e){if(e.length===0)return null;var t=this._socket.request,n=t.headers["sec-websocket-key1"],r=numberFromKey(n)/spacesInKey(n),i=t.headers["sec-websocket-key2"],s=numberFromKey(i)/spacesInKey(i),o=crypto.createHash("md5");o.update(bigEndian(r));o.update(bigEndian(s));o.update(e.toString("binary"));this._handshakeComplete=!0;return new Buffer(o.digest("binary"),"binary")};Draft76Parser.prototype.parse=function(e){return this._handshakeComplete?Draft75Parser.prototype.parse.call(this,e):this.handshakeSignature(e)};Draft76Parser.prototype._parseLeadingByte=function(e){if(e!==255)return Draft75Parser.prototype._parseLeadingByte.call(this,e);this._closing=!0;this._length=0;this._stage=1};Draft76Parser.prototype.close=function(e,t,n,r){if(this._closed)return;this._closing&&this._socket.send(new Buffer([255,0]));this._closed=!0;n&&n.call(r)};module.exports=Draft76Parser;