var Client=require("../../../lib/faye/websocket/client");JS.ENV.WebSocketSteps=JS.Test.asyncSteps({server:function(e,t,n){this._adapter=new EchoServer;this._adapter.listen(e,t);this._port=e;setTimeout(n,100)},stop:function(e){this._adapter.stop();setTimeout(e,100)},open_socket:function(e,t,n){var r=!1,i=this,s=function(e){if(r)return;r=!0;i._open=e;n()};this._ws=new Client(e,t,{verify:!1});this._ws.onopen=function(){s(!0)};this._ws.onclose=function(){s(!1)}},close_socket:function(e){var t=this;this._ws.onclose=function(){t._open=!1;e()};this._ws.close()},check_open:function(e){this.assert(this._open);e()},check_closed:function(e){this.assert(!this._open);e()},check_protocol:function(e,t){this.assertEqual(e,this._ws.protocol);t()},listen_for_message:function(e){var t=this;this._ws.addEventListener("message",function(e){t._message=e.data});e()},send_message:function(e,t){this._ws.send(e);setTimeout(t,100)},check_response:function(e,t){this.assertEqual(e,this._message);t()},check_no_response:function(e){this.assert(!this._message);e()}});JS.ENV.ClientSpec=JS.Test.describe("Client",function(){with(this){include(WebSocketSteps);before(function(){this.protocols=["foo","echo"];this.plain_text_url="ws://localhost:8000/bayeux";this.secure_url="wss://localhost:8000/bayeux"});sharedBehavior("socket client",function(){with(this){it("can open a connection",function(){with(this){open_socket(socket_url,protocols);check_open();check_protocol("echo")}});it("cannot open a connection with unacceptable protocols",function(){with(this){open_socket(socket_url,["foo"]);check_closed()}});it("can close the connection",function(){with(this){open_socket(socket_url,protocols);close_socket();check_closed()}});describe("in the OPEN state",function(){with(this){before(function(){with(this)open_socket(socket_url,protocols)});it("can send and receive messages",function(){with(this){listen_for_message();send_message("I expect this to be echoed");check_response("I expect this to be echoed")}});it("sends numbers as strings",function(){with(this){listen_for_message();send_message(13);check_response("13")}});it("sends booleans as strings",function(){with(this){listen_for_message();send_message(!1);check_response("false")}});it("sends arrays as strings",function(){with(this){listen_for_message();send_message([13,14,15]);check_response("13,14,15")}})}});describe("in the CLOSED state",function(){with(this){before(function(){with(this){open_socket(socket_url,protocols);close_socket()}});it("cannot send and receive messages",function(){with(this){listen_for_message();send_message("I expect this to be echoed");check_no_response()}})}})}});describe("with a plain-text server",function(){with(this){before(function(){this.socket_url=this.plain_text_url;this.blocked_url=this.secure_url});before(function(){this.server(8e3,!1)});after(function(){this.stop()});behavesLike("socket client")}});describe("with a secure server",function(){with(this){before(function(){this.socket_url=this.secure_url;this.blocked_url=this.plain_text_url});before(function(){this.server(8e3,!0)});after(function(){this.stop()});behavesLike("socket client")}})}});