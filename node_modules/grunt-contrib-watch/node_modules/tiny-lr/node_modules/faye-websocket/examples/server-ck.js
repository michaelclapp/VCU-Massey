var WebSocket=require("../lib/faye/websocket"),fs=require("fs"),http=require("http"),https=require("https"),port=process.argv[2]||7e3,secure=process.argv[3]==="ssl",upgradeHandler=function(e,t,n){var r=new WebSocket(e,t,n,["irc","xmpp"],{ping:5});console.log("open",r.url,r.version,r.protocol);r.onmessage=function(e){r.send(e.data)};r.onclose=function(e){console.log("close",e.code,e.reason);r=null}},requestHandler=function(e,t){if(!WebSocket.EventSource.isEventSource(e))return staticHandler(e,t);var n=new WebSocket.EventSource(e,t),r=parseInt(n.lastEventId,10)||0;console.log("open",n.url,n.lastEventId);var i=setInterval(function(){r+=1;n.send("Time: "+r);setTimeout(function(){n&&n.send("Update!!",{event:"update",id:r})},1e3)},2e3);n.send("Welcome!\n\nThis is an EventSource server.");n.onclose=function(){clearInterval(i);console.log("close",n.url);n=null}},staticHandler=function(e,t){var n=e.url;fs.readFile(__dirname+n,function(e,n){var r=e?404:200;t.writeHead(r,{"Content-Type":"text/html"});t.write(n||"Not found");t.end()})},server=secure?https.createServer({key:fs.readFileSync(__dirname+"/../spec/server.key"),cert:fs.readFileSync(__dirname+"/../spec/server.crt")}):http.createServer();server.addListener("request",requestHandler);server.addListener("upgrade",upgradeHandler);server.listen(port);