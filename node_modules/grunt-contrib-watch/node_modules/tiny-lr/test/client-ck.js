var request=require("supertest"),assert=require("assert"),parse=require("url").parse,WebSocket=require("faye-websocket").Client,Server=require("..").Server;describe("tiny-lr",function(){before(function(e){this.app=new Server;this.server=this.app.server;this.request=request(this.server).get("/").expect(200,e)});it("accepts ws clients",function(e){var t=parse(this.request.url),n=this.app,r=this.ws=new WebSocket("ws://"+t.host+"/livereload");r.onopen=function(e){var t={command:"hello",protocols:["http://livereload.com/protocols/official-7"]};r.send(JSON.stringify(t))};r.onmessage=function(t){assert.deepEqual(t.data,JSON.stringify({command:"hello",protocols:["http://livereload.com/protocols/official-7"],serverName:"tiny-lr"}));assert.ok(Object.keys(n.clients).length);e()}});it("properly cleans up established connection on exit",function(e){var t=this.ws;t.onclose=e.bind(null,null);request(this.server).get("/kill").expect(200,function(){})})});