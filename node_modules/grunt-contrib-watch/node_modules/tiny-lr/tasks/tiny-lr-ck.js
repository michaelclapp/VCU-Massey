var fs=require("fs"),Server=require("..").Server;module.exports=function(e){function i(){if(e.file.watchFiles)return e.file.watchFiles.changed;var t=e.config("watch"),n=Object.keys(t).filter(function(e){var n=t[e].tasks;return n?~n.indexOf("reload"):!1}).reduce(function(e,n){return e.concat(t[n].files||[])},[]);n=e.file.expandFiles(n).filter(s("node_modules"));var r=i.stats=i.stats||{},o=n.map(function(e){var t=fs.statSync(e);t.file=e;return t}).reduce(function(e,t){e[t.file]=t.mtime.getTime();return e},{});n=Object.keys(o).filter(function(e){return r[e]?r[e]!==o[e]:!0});i.stats=o;return n}function s(e){return function(t){return!~t.indexOf(e)}}var t=e.util||e.utils,n=t._,r;e.registerTask("tinylr-start","Start the tiny livereload server",function(){var t=n.defaults(e.config("tiny-lr")||{},{port:35729});i();var s=this.async();r=new Server;e.log.writeln("... Starting server on "+t.port+" ...");r.listen(t.port,this.async())});e.registerTask("tinylr-reload","Sends a reload notification to the livereload server, based on `watchFiles.changed`",function(){if(!r)return;var t=i();e.log.verbose.writeln("... Reloading "+e.log.wordlist(t)+" ...");r.changed({body:{files:t}})})};