/*
 * grunt-html-validation
 * https://github.com/praveen/grunt-html-validation
 *
 * Copyright (c) 2013 Praveen Vijayan
 * Licensed under the MIT license.
 */"use strict";module.exports=function(e){var t=require("w3cjs"),n=require("colors"),r=require("fs"),i=require("path"),s=require("request"),o=require("../lib/remoteval");n.setTheme({silly:"rainbow",input:"grey",verbose:"cyan",prompt:"grey",info:"green",data:"grey",help:"cyan",warn:"yellow",debug:"blue",error:"red",blue:"blue"});var u="",a=[],f=0,l={error:"Something went wrong",ok:"Validation successful..",start:"Validation started for.. ".info,networkError:"Network error re-validating..".error,validFile:"Validated skipping..",nofile:":- No file is specified in the path!",nextfile:"Skipping to next file..".verbose,eof:"End of File..".verbose,fileNotFound:"File not found..".error,remotePathError:"Remote path ".error+"(options->remotePath) ".grey+"is mandatory when remote files ".error+"(options-> remoteFiles) ".grey+"are specified!".error},c,h={},p,d=0,v="",m=[],g=0,y="";e.registerMultiTask("validation","HTML W3C validation.",function(){function w(e){for(var t=0,r=n.relaxerror.length;t<r;t++){var i=new RegExp(n.relaxerror[t],"g");if(i.test(e))return!0}}var n=this.options({path:"validation-status.json",reportpath:"validation-report.json",reset:!1,stoponerror:!1,remotePath:!1,maxTry:3,relaxerror:[],doctype:!1,charset:!1}),r=this.async(),i=e.file.expand(this.filesSrc),s=i.length,u={},a=[],h=!1;h=n.relaxerror.length&&n.relaxerror.length!=="";var p=function(e){return e.map(function(e){return n.remotePath+e})};n.reset&&e.file.write(n.path,"{}");if(!s){var d=this.data.src;console.log(d+l.nofile.error)}var v=function(e,t){var n=[];for(var r=0;r<t.length;r++)w(t[r].message)||n.push(t[r]);var i={};i.filename=e;i.error=n;m.push(i)},b=function(i){if(i.length){e.file.exists(n.path)&&(u=e.file.readJSON(n.path));var a=u[i[f]]||!1;if(a){console.log(l.validFile.green+i[f]);y=n.remoteFiles?E[f]:i[f];v(y,!1);f++;b(i);return}if(i[f]!==undefined){var p=n.remoteFiles?E[f]:i[f];console.log(l.start+p)}var d=t.validate({file:i[f],output:"json",doctype:n.doctype,charset:n.charset,callback:function(t){function p(t){u[i[f]]=!0;e.log.ok(l.ok.green);y=n.remoteFiles?E[f]:i[f];v(y,!1)}s=i.length;if(!t.messages){++g;var a=l.networkError+" "+g.toString().error+" ";if(g===n.maxTry){f++;f!==s?a+=l.nextfile:a+=l.eof;g=0}console.log(a);b(i);return}c=t.messages.length;if(c){var d=0;for(var S in t.messages){var x;h&&(x=w(t.messages[S].message));if(!x){d+=1;console.log(d+"=> ".warn+JSON.stringify(t.messages[S].message).help+" Line no: "+JSON.stringify(t.messages[S].lastLine).prompt)}}d!==0&&console.log("No of errors: ".error+d);u[i[f]]=!1;y=n.remoteFiles?E[f]:i[f];v(y,t.messages);if(n.stoponerror){r();return}h&&d===0&&p()}else p();e.file.write(n.path,JSON.stringify(u));f++;if(n.reportpath&&f===s){e.file.write(n.reportpath,JSON.stringify(m));console.log("Validation report generated: ".green+n.reportpath);r()}if(n.remoteFiles){if(f===s)return;o(E[f],function(){b(i)})}else b(i)}})}};if(!n.remotePath&&n.remoteFiles){console.log(l.remotePathError);return}n.remotePath&&n.remotePath!==""&&(i=p(i));if(n.remoteFiles){typeof n.remoteFiles=="object"&&n.remoteFiles.length&&n.remoteFiles[0]!==""?i=n.remoteFiles:i=e.file.readJSON(n.remoteFiles);i=p(i);var E=i;i=[];for(var S=0;S<E.length;S++)i.push("_tempvlidation.html");o(E[f],function(){b(i)});return}n.remoteFiles||b(i)})};