var common=require("../common"),BOUNDARY="---------------------------10102754414578508781458777923",FIXTURE=TEST_FIXTURES+"/multi_video.upload",fs=require("fs"),http=require("http"),formidable=require(common.lib+"/index"),server=http.createServer();server.on("request",function(e,t){var n=new formidable.IncomingForm,r={};n.uploadDir=TEST_TMP;n.hash="sha1";n.parse(e);n.on("fileBegin",function(e,t){assert.equal(e,"upload");var n={file:t,progress:[],ended:!1};r[t.name]=n;t.on("progress",function(e){n.progress.push(e);assert.equal(e,t.size)}).on("end",function(){n.ended=!0})}).on("field",function(e,t){assert.equal(e,"title");assert.equal(t,"")}).on("file",function(e,t){assert.equal(e,"upload");assert.strictEqual(r[t.name].file,t)}).on("end",function(){assert.ok(r["shortest_video.flv"]);assert.ok(r["shortest_video.flv"].ended);assert.ok(r["shortest_video.flv"].progress.length>3);assert.equal(r["shortest_video.flv"].file.hash,"d6a17616c7143d1b1438ceeef6836d1a09186b3a");assert.equal(r["shortest_video.flv"].progress.slice(-1),r["shortest_video.flv"].file.size);assert.ok(r["shortest_video.mp4"]);assert.ok(r["shortest_video.mp4"].ended);assert.ok(r["shortest_video.mp4"].progress.length>3);assert.equal(r["shortest_video.mp4"].file.hash,"937dfd4db263f4887ceae19341dcc8d63bcd557f");server.close();t.writeHead(200);t.end("good")})});server.listen(TEST_PORT,function(){var e,t,n,r;e=fs.statSync(FIXTURE);n=http.request({port:TEST_PORT,path:"/",method:"POST",headers:{"content-type":"multipart/form-data; boundary="+BOUNDARY,"content-length":e.size}});fs.createReadStream(FIXTURE).pipe(n)});