function MultipartParser(){this.boundary=null;this.boundaryChars=null;this.lookbehind=null;this.state=S.PARSER_UNINITIALIZED;this.index=null;this.flags=0}var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return e|32};for(s in S)exports[s]=S[s];exports.MultipartParser=MultipartParser;MultipartParser.stateToString=function(e){for(var t in S){var n=S[t];if(n===e)return t}};MultipartParser.prototype.initWithBoundary=function(e){this.boundary=new Buffer(e.length+4);this.boundary.write("\r\n--","ascii",0);this.boundary.write(e,"ascii",4);this.lookbehind=new Buffer(this.boundary.length+8);this.state=S.START;this.boundaryChars={};for(var t=0;t<this.boundary.length;t++)this.boundaryChars[this.boundary[t]]=!0};MultipartParser.prototype.write=function(e){var t=this,n=0,r=e.length,i=this.index,s=this.index,o=this.state,u=this.flags,a=this.lookbehind,f=this.boundary,l=this.boundaryChars,c=this.boundary.length,h=c-1,p=e.length,d,v,m=function(e){t[e+"Mark"]=n},g=function(e){delete t[e+"Mark"]},y=function(e,n,r,i){if(r!==undefined&&r===i)return;var s="on"+e.substr(0,1).toUpperCase()+e.substr(1);s in t&&t[s](n,r,i)},b=function(r,i){var s=r+"Mark";if(!(s in t))return;if(!i){y(r,e,t[s],e.length);t[s]=0}else{y(r,e,t[s],n);delete t[s]}};for(n=0;n<r;n++){d=e[n];switch(o){case S.PARSER_UNINITIALIZED:return n;case S.START:s=0;o=S.START_BOUNDARY;case S.START_BOUNDARY:if(s==f.length-2){if(d!=CR)return n;s++;break}if(s-1==f.length-2){if(d!=LF)return n;s=0;y("partBegin");o=S.HEADER_FIELD_START;break}d!=f[s+2]&&(s=-2);d==f[s+2]&&s++;break;case S.HEADER_FIELD_START:o=S.HEADER_FIELD;m("headerField");s=0;case S.HEADER_FIELD:if(d==CR){g("headerField");o=S.HEADERS_ALMOST_DONE;break}s++;if(d==HYPHEN)break;if(d==COLON){if(s==1)return n;b("headerField",!0);o=S.HEADER_VALUE_START;break}v=lower(d);if(v<A||v>Z)return n;break;case S.HEADER_VALUE_START:if(d==SPACE)break;m("headerValue");o=S.HEADER_VALUE;case S.HEADER_VALUE:if(d==CR){b("headerValue",!0);y("headerEnd");o=S.HEADER_VALUE_ALMOST_DONE}break;case S.HEADER_VALUE_ALMOST_DONE:if(d!=LF)return n;o=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(d!=LF)return n;y("headersEnd");o=S.PART_DATA_START;break;case S.PART_DATA_START:o=S.PART_DATA;m("partData");case S.PART_DATA:i=s;if(s==0){n+=h;while(n<p&&!(e[n]in l))n+=c;n-=h;d=e[n]}if(s<f.length)if(f[s]==d){s==0&&b("partData",!0);s++}else s=0;else if(s==f.length){s++;d==CR?u|=F.PART_BOUNDARY:d==HYPHEN?u|=F.LAST_BOUNDARY:s=0}else if(s-1==f.length)if(u&F.PART_BOUNDARY){s=0;if(d==LF){u&=~F.PART_BOUNDARY;y("partEnd");y("partBegin");o=S.HEADER_FIELD_START;break}}else if(u&F.LAST_BOUNDARY)if(d==HYPHEN){y("partEnd");y("end");o=S.END}else s=0;else s=0;if(s>0)a[s-1]=d;else if(i>0){y("partData",a,0,i);i=0;m("partData");n--}break;case S.END:break;default:return n}}b("headerField");b("headerValue");b("partData");this.index=s;this.state=o;this.flags=u;return r};MultipartParser.prototype.end=function(){var e=function(e,t){var n="on"+t.substr(0,1).toUpperCase()+t.substr(1);n in e&&e[n]()};if(this.state==S.HEADER_FIELD_START&&this.index==0||this.state==S.PART_DATA&&this.index==this.boundary.length){e(this,"partEnd");e(this,"end")}else if(this.state!=S.END)return new Error("MultipartParser.end(): stream ended unexpectedly: "+this.explain())};MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)};