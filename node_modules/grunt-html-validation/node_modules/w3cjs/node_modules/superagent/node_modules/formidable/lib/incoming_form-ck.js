function IncomingForm(e){if(this instanceof IncomingForm){EventEmitter.call(this);e=e||{};this.error=null;this.ended=!1;this.maxFields=e.maxFields||1e3;this.maxFieldsSize=e.maxFieldsSize||2097152;this.keepExtensions=e.keepExtensions||!1;this.uploadDir=e.uploadDir||os.tmpDir();this.encoding=e.encoding||"utf-8";this.headers=null;this.type=null;this.hash=!1;this.bytesReceived=null;this.bytesExpected=null;this._parser=null;this._flushing=0;this._fieldsSize=0;this.openedFiles=[];return this}return new IncomingForm(e)}function dummyParser(e){return{end:function(){e.ended=!0;e._maybeEnd();return null}}}global.GENTLY&&(require=GENTLY.hijack(require));var fs=require("fs"),util=require("util"),path=require("path"),File=require("./file"),MultipartParser=require("./multipart_parser").MultipartParser,QuerystringParser=require("./querystring_parser").QuerystringParser,OctetParser=require("./octet_parser").OctetParser,JSONParser=require("./json_parser").JSONParser,StringDecoder=require("string_decoder").StringDecoder,EventEmitter=require("events").EventEmitter,Stream=require("stream").Stream,os=require("os");util.inherits(IncomingForm,EventEmitter);exports.IncomingForm=IncomingForm;IncomingForm.prototype.parse=function(e,t){this.pause=function(){try{e.pause()}catch(t){this.ended||this._error(t);return!1}return!0};this.resume=function(){try{e.resume()}catch(t){this.ended||this._error(t);return!1}return!0};if(t){var n={},r={};this.on("field",function(e,t){n[e]=t}).on("file",function(e,t){r[e]=t}).on("error",function(e){t(e,n,r)}).on("end",function(){t(null,n,r)})}this.writeHeaders(e.headers);var i=this;e.on("error",function(e){i._error(e)}).on("aborted",function(){i.emit("aborted");i._error(new Error("Request aborted"))}).on("data",function(e){i.write(e)}).on("end",function(){if(i.error)return;var e=i._parser.end();e&&i._error(e)});return this};IncomingForm.prototype.writeHeaders=function(e){this.headers=e;this._parseContentLength();this._parseContentType()};IncomingForm.prototype.write=function(e){if(!this._parser){this._error(new Error("unintialized parser"));return}this.bytesReceived+=e.length;this.emit("progress",this.bytesReceived,this.bytesExpected);var t=this._parser.write(e);t!==e.length&&this._error(new Error("parser error, "+t+" of "+e.length+" bytes parsed"));return t};IncomingForm.prototype.pause=function(){return!1};IncomingForm.prototype.resume=function(){return!1};IncomingForm.prototype.onPart=function(e){this.handlePart(e)};IncomingForm.prototype.handlePart=function(e){var t=this;if(e.filename===undefined){var n="",r=new StringDecoder(this.encoding);e.on("data",function(e){t._fieldsSize+=e.length;if(t._fieldsSize>t.maxFieldsSize){t._error(new Error("maxFieldsSize exceeded, received "+t._fieldsSize+" bytes of field data"));return}n+=r.write(e)});e.on("end",function(){t.emit("field",e.name,n)});return}this._flushing++;var i=new File({path:this._uploadPath(e.filename),name:e.filename,type:e.mime,hash:t.hash});this.emit("fileBegin",e.name,i);i.open();this.openedFiles.push(i);e.on("data",function(e){t.pause();i.write(e,function(){t.resume()})});e.on("end",function(){i.end(function(){t._flushing--;t.emit("file",e.name,i);t._maybeEnd()})})};IncomingForm.prototype._parseContentType=function(){if(this.bytesExpected===0){this._parser=dummyParser(this);return}if(!this.headers["content-type"]){this._error(new Error("bad content-type header, no content-type"));return}if(this.headers["content-type"].match(/octet-stream/i)){this._initOctetStream();return}if(this.headers["content-type"].match(/urlencoded/i)){this._initUrlencoded();return}if(this.headers["content-type"].match(/multipart/i)){var e;(e=this.headers["content-type"].match(/boundary=(?:"([^"]+)"|([^;]+))/i))?this._initMultipart(e[1]||e[2]):this._error(new Error("bad content-type header, no multipart boundary"));return}if(this.headers["content-type"].match(/json/i)){this._initJSONencoded();return}this._error(new Error("bad content-type header, unknown content-type: "+this.headers["content-type"]))};IncomingForm.prototype._error=function(e){if(this.error||this.ended)return;this.error=e;this.pause();this.emit("error",e);Array.isArray(this.openedFiles)&&this.openedFiles.forEach(function(e){e._writeStream.destroy();setTimeout(fs.unlink,0,e.path)})};IncomingForm.prototype._parseContentLength=function(){this.bytesReceived=0;this.headers["content-length"]?this.bytesExpected=parseInt(this.headers["content-length"],10):this.headers["transfer-encoding"]===undefined&&(this.bytesExpected=0);this.bytesExpected!==null&&this.emit("progress",this.bytesReceived,this.bytesExpected)};IncomingForm.prototype._newParser=function(){return new MultipartParser};IncomingForm.prototype._initMultipart=function(e){this.type="multipart";var t=new MultipartParser,n=this,r,i,s;t.initWithBoundary(e);t.onPartBegin=function(){s=new Stream;s.readable=!0;s.headers={};s.name=null;s.filename=null;s.mime=null;s.transferEncoding="binary";s.transferBuffer="";r="";i=""};t.onHeaderField=function(e,t,i){r+=e.toString(n.encoding,t,i)};t.onHeaderValue=function(e,t,r){i+=e.toString(n.encoding,t,r)};t.onHeaderEnd=function(){r=r.toLowerCase();s.headers[r]=i;var e;if(r=="content-disposition"){if(e=i.match(/\bname="([^"]+)"/i))s.name=e[1];s.filename=n._fileName(i)}else r=="content-type"?s.mime=i:r=="content-transfer-encoding"&&(s.transferEncoding=i.toLowerCase());r="";i=""};t.onHeadersEnd=function(){switch(s.transferEncoding){case"binary":case"7bit":case"8bit":t.onPartData=function(e,t,n){s.emit("data",e.slice(t,n))};t.onPartEnd=function(){s.emit("end")};break;case"base64":t.onPartData=function(e,t,n){s.transferBuffer+=e.slice(t,n).toString("ascii");var r=parseInt(s.transferBuffer.length/4)*4;s.emit("data",new Buffer(s.transferBuffer.substring(0,r),"base64"));s.transferBuffer=s.transferBuffer.substring(r)};t.onPartEnd=function(){s.emit("data",new Buffer(s.transferBuffer,"base64"));s.emit("end")};break;default:return n._error(new Error("unknown transfer-encoding"))}n.onPart(s)};t.onEnd=function(){n.ended=!0;n._maybeEnd()};this._parser=t};IncomingForm.prototype._fileName=function(e){var t=e.match(/\bfilename="(.*?)"($|; )/i);if(!t)return;var n=t[1].substr(t[1].lastIndexOf("\\")+1);n=n.replace(/%22/g,'"');n=n.replace(/&#([\d]{4});/g,function(e,t){return String.fromCharCode(t)});return n};IncomingForm.prototype._initUrlencoded=function(){this.type="urlencoded";var e=new QuerystringParser(this.maxFields),t=this;e.onField=function(e,n){t.emit("field",e,n)};e.onEnd=function(){t.ended=!0;t._maybeEnd()};this._parser=e};IncomingForm.prototype._initOctetStream=function(){this.type="octet-stream";var e=this.headers["x-file-name"],t=this.headers["content-type"],n=new File({path:this._uploadPath(e),name:e,type:t});n.open();this.emit("fileBegin",e,n);this._flushing++;var r=this;r._parser=new OctetParser;var i=0;r._parser.on("data",function(e){r.pause();i++;n.write(e,function(){i--;r.resume();r.ended&&r._parser.emit("doneWritingFile")})});r._parser.on("end",function(){r._flushing--;r.ended=!0;var e=function(){r.emit("file","file",n);r._maybeEnd()};i===0?e():r._parser.once("doneWritingFile",e)})};IncomingForm.prototype._initJSONencoded=function(){this.type="json";var e=new JSONParser,t=this;this.bytesExpected&&e.initWithLength(this.bytesExpected);e.onField=function(e,n){t.emit("field",e,n)};e.onEnd=function(){t.ended=!0;t._maybeEnd()};this._parser=e};IncomingForm.prototype._uploadPath=function(e){var t="";for(var n=0;n<32;n++)t+=Math.floor(Math.random()*16).toString(16);if(this.keepExtensions){var r=path.extname(e);r=r.replace(/(\.[a-z0-9]+).*/,"$1");t+=r}return path.join(this.uploadDir,t)};IncomingForm.prototype._maybeEnd=function(){if(!this.ended||this._flushing||this.error)return;this.emit("end")};