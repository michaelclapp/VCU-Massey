function test(e){gently=new Gently;gently.expect(EventEmitterStub,"call");form=new IncomingForm;e();gently.verify(e.name)}var common=require("../common"),MultipartParserStub=GENTLY.stub("./multipart_parser","MultipartParser"),QuerystringParserStub=GENTLY.stub("./querystring_parser","QuerystringParser"),EventEmitterStub=GENTLY.stub("events","EventEmitter"),StreamStub=GENTLY.stub("stream","Stream"),FileStub=GENTLY.stub("./file"),formidable=require(common.lib+"/index"),IncomingForm=formidable.IncomingForm,events=require("events"),fs=require("fs"),path=require("path"),Buffer=require("buffer").Buffer,fixtures=require(TEST_FIXTURES+"/multipart"),form,gently;test(function e(){assert.strictEqual(form.error,null);assert.strictEqual(form.ended,!1);assert.strictEqual(form.type,null);assert.strictEqual(form.headers,null);assert.strictEqual(form.keepExtensions,!1);assert.doesNotThrow(function(){assert(fs.statSync(form.uploadDir).isDirectory())});assert.strictEqual(form.encoding,"utf-8");assert.strictEqual(form.bytesReceived,null);assert.strictEqual(form.bytesExpected,null);assert.strictEqual(form.maxFieldsSize,2097152);assert.strictEqual(form._parser,null);assert.strictEqual(form._flushing,0);assert.strictEqual(form._fieldsSize,0);assert.ok(form instanceof EventEmitterStub);assert.equal(form.constructor.name,"IncomingForm");(function(){gently.expect(EventEmitterStub,"call");var t=IncomingForm();assert.ok(t instanceof IncomingForm)})();(function(){gently.expect(EventEmitterStub,"call");var t=formidable();assert.ok(t instanceof IncomingForm)})()});test(function(){var t={headers:{}},n={};gently.expect(form,"writeHeaders",function(e){assert.strictEqual(e,t.headers)});var r=["error","aborted","data","end"];gently.expect(t,"on",r.length,function(e,t){assert.equal(e,r.shift());n[e]=t;return this});form.parse(t);(function(){gently.expect(t,"pause");assert.strictEqual(form.pause(),!0)})();(function(){form.ended=!1;var n=new Error("dasdsa");gently.expect(t,"pause",function(){throw n});gently.expect(form,"_error",function(e){assert.strictEqual(e,n)});assert.strictEqual(form.pause(),!1)})();(function(){form.ended=!0;var n=new Error("dasdsa");gently.expect(t,"pause",function(){throw n});assert.strictEqual(form.pause(),!1)})();(function(){gently.expect(t,"resume");assert.strictEqual(form.resume(),!0)})();(function(){form.ended=!1;var n=new Error("dasdsa");gently.expect(t,"resume",function(){throw n});gently.expect(form,"_error",function(e){assert.strictEqual(e,n)});assert.strictEqual(form.resume(),!1)})();(function(){form.ended=!0;var n=new Error("dasdsa");gently.expect(t,"resume",function(){throw n});assert.strictEqual(form.resume(),!1)})();(function(){var t=new Error("something bad happened");gently.expect(form,"_error",function(e){assert.strictEqual(e,t)});n.error(t)})();(function(){gently.expect(form,"emit",function(e){assert.equal(e,"aborted")});gently.expect(form,"_error");n.aborted()})();(function(){var t=[1,2,3];gently.expect(form,"write",function(e){assert.strictEqual(e,t)});n.data(t)})();(function(){form._parser={};(function(){var t=new Error("haha");gently.expect(form._parser,"end",function(){return t});gently.expect(form,"_error",function(e){assert.strictEqual(e,t)});n.end()})();(function(){gently.expect(form._parser,"end");n.end()})();(function(){form.error=!0;n.end()})()})();(function(){gently.expect(EventEmitterStub,"call");var t=new IncomingForm,n={headers:{}},r=0;gently.expect(t,"on",4,function(e,t){if(e=="field"){t("field1","foo");t("field1","bar");t("field2","nice")}if(e=="file"){t("file1","1");t("file1","2");t("file2","3")}e=="end"&&t();return this});gently.expect(t,"writeHeaders");gently.expect(n,"on",4,function(){return this});var i=function(e,t,n){assert.deepEqual(t,{field1:"bar",field2:"nice"});assert.deepEqual(n,{file1:"2",file2:"3"})};t.parse(n,i);var s=new Error("test");gently.expect(t,"on",3,function(e,r){e=="field"&&r("foo","bar");if(e=="error"){r(s);gently.expect(t,"on");gently.expect(t,"writeHeaders");gently.expect(n,"on",4,function(){return this})}return this});t.parse(n,function(t,n,r){assert.strictEqual(t,s);assert.deepEqual(n,{foo:"bar"})})})();(function(){gently.expect(EventEmitterStub,"call");var t=new IncomingForm,n=new events.EventEmitter,r={},i=null;n.on("newListener",function(e,t){"data"===e&&t(r)});gently.expect(t,"writeHeaders");gently.expect(t,"write",function(e){assert.strictEqual(e,r)});t.parse(n)})()});test(function(){assert.strictEqual(form.pause(),!1)});test(function(){assert.strictEqual(form.resume(),!1)});test(function(){var t={};gently.expect(form,"_parseContentLength");gently.expect(form,"_parseContentType");form.writeHeaders(t);assert.strictEqual(form.headers,t)});test(function(){var t={},n=[1,2,3];form._parser=t;form.bytesExpected=523423;(function(){gently.expect(form,"emit",function(e,t,r){assert.equal(e,"progress");assert.equal(t,n.length);assert.equal(r,form.bytesExpected)});gently.expect(t,"write",function(e){assert.strictEqual(e,n);return e.length});assert.equal(form.write(n),n.length);assert.equal(form.bytesReceived,n.length)})();(function(){gently.expect(form,"emit");gently.expect(t,"write",function(e){assert.strictEqual(e,n);return e.length-1});gently.expect(form,"_error",function(e){assert.ok(e.message.match(/parser error/i))});assert.equal(form.write(n),n.length-1);assert.equal(form.bytesReceived,n.length+n.length)})();(function(){delete form._parser;gently.expect(form,"_error",function(e){assert.ok(e.message.match(/unintialized parser/i))});form.write(n)})()});test(function(){var t={};form.headers={"content-type":"application/x-www-form-urlencoded"};gently.expect(form,"_initUrlencoded");form._parseContentType();form.headers={"content-type":"broken-client/urlencoded-stupid"};gently.expect(form,"_initUrlencoded");form._parseContentType();var n="---------------------------57814261102167618332366269";form.headers={"content-type":"multipart/form-data; boundary="+n};gently.expect(form,"_initMultipart",function(e){assert.equal(e,n)});form._parseContentType();(function(){form.headers={"content-type":'multipart/form-data; boundary="'+n+'"'};gently.expect(form,"_initMultipart",function(e){assert.equal(e,n)});form._parseContentType()})();(function(){form.headers={"content-type":"multipart/form-data"};gently.expect(form,"_error",function(e){assert.ok(e.message.match(/no multipart boundary/i))});form._parseContentType()})();(function(){form.headers={};gently.expect(form,"_error",function(e){assert.ok(e.message.match(/no content-type/i))});form._parseContentType()})();(function(){form.headers={"content-type":"invalid"};gently.expect(form,"_error",function(e){assert.ok(e.message.match(/unknown content-type/i))});form._parseContentType()})()});test(function(){var t={};form.headers={};gently.expect(form,"emit",function(e,t,n){assert.equal(e,"progress");assert.equal(t,0);assert.equal(n,0)});form._parseContentLength();form.headers["content-length"]="8";gently.expect(form,"emit",function(e,t,n){assert.equal(e,"progress");assert.equal(t,0);assert.equal(n,8)});form._parseContentLength();assert.strictEqual(form.bytesReceived,0);assert.strictEqual(form.bytesExpected,8);form.headers["content-length"]="08";gently.expect(form,"emit",function(e,t,n){assert.equal(e,"progress");assert.equal(t,0);assert.equal(n,8)});form._parseContentLength();assert.strictEqual(form.bytesExpected,8)});test(function(){var t="123",n;gently.expect(MultipartParserStub,"new",function(){n=this});gently.expect(MultipartParserStub.prototype,"initWithBoundary",function(e){assert.equal(e,t)});form._initMultipart(t);assert.equal(form.type,"multipart");assert.strictEqual(form._parser,n);(function(){var t;gently.expect(StreamStub,"new",function(){t=this});gently.expect(form,"onPart",function(e){assert.strictEqual(e,t);assert.deepEqual(e.headers,{"content-disposition":'form-data; name="field1"',foo:"bar"});assert.equal(e.name,"field1");var n=["hello"," world"];gently.expect(e,"emit",2,function(e,t){assert.equal(e,"data");assert.equal(t.toString(),n.shift())});gently.expect(e,"emit",function(e,t){assert.equal(e,"end")})});n.onPartBegin();n.onHeaderField(new Buffer("content-disposition"),0,10);n.onHeaderField(new Buffer("content-disposition"),10,19);n.onHeaderValue(new Buffer('form-data; name="field1"'),0,14);n.onHeaderValue(new Buffer('form-data; name="field1"'),14,24);n.onHeaderEnd();n.onHeaderField(new Buffer("foo"),0,3);n.onHeaderValue(new Buffer("bar"),0,3);n.onHeaderEnd();n.onHeadersEnd();n.onPartData(new Buffer("hello world"),0,5);n.onPartData(new Buffer("hello world"),5,11);n.onPartEnd()})();(function(){var t;gently.expect(StreamStub,"new",function(){t=this});gently.expect(form,"onPart",function(e){assert.deepEqual(e.headers,{"content-disposition":'form-data; name="field2"; filename="C:\\Documents and Settings\\IE\\Must\\Die\\Sun"et.jpg"',"content-type":"text/plain"});assert.equal(e.name,"field2");assert.equal(e.filename,'Sun"et.jpg');assert.equal(e.mime,"text/plain");gently.expect(e,"emit",function(e,t){assert.equal(e,"data");assert.equal(t.toString(),"... contents of file1.txt ...")});gently.expect(e,"emit",function(e,t){assert.equal(e,"end")})});n.onPartBegin();n.onHeaderField(new Buffer("content-disposition"),0,19);n.onHeaderValue(new Buffer('form-data; name="field2"; filename="C:\\Documents and Settings\\IE\\Must\\Die\\Sun"et.jpg"'),0,85);n.onHeaderEnd();n.onHeaderField(new Buffer("Content-Type"),0,12);n.onHeaderValue(new Buffer("text/plain"),0,10);n.onHeaderEnd();n.onHeadersEnd();n.onPartData(new Buffer("... contents of file1.txt ..."),0,29);n.onPartEnd()})();(function(){gently.expect(form,"_maybeEnd");n.onEnd();assert.ok(form.ended)})()});test(function(){return});test(function(){var t;gently.expect(QuerystringParserStub,"new",function(){t=this});form._initUrlencoded();assert.equal(form.type,"urlencoded");assert.strictEqual(form._parser,t);(function(){var n="KEY",r="VAL";gently.expect(form,"emit",function(e,t,i){assert.equal(e,"field");assert.equal(t,n);assert.equal(i,r)});t.onField(n,r)})();(function(){gently.expect(form,"_maybeEnd");t.onEnd();assert.equal(form.ended,!0)})()});test(function(){var t=new Error("bla");gently.expect(form,"pause");gently.expect(form,"emit",function(e,n){assert.equal(e,"error");assert.strictEqual(n,t)});form._error(t);assert.strictEqual(form.error,t);form._error(t)});test(function(){var t={};gently.expect(form,"handlePart",function(e){assert.strictEqual(e,t)});form.onPart(t)});test(function(){(function(){var t=new events.EventEmitter;t.name="my_field";gently.expect(form,"emit",function(e,t,n){assert.equal(e,"field");assert.equal(t,"my_field");assert.equal(n,"hello world: €")});form.handlePart(t);t.emit("data",new Buffer("hello"));t.emit("data",new Buffer(" world: "));t.emit("data",new Buffer([226]));t.emit("data",new Buffer([130,172]));t.emit("end")})();(function(){var t=new events.EventEmitter;t.name="my_field2";gently.expect(form,"emit",function(e,t,n){assert.equal(e,"field");assert.equal(t,"my_field2");assert.equal(n,"hello world: "+(new Buffer([226,130,172])).toString("binary"))});form.encoding="binary";form.handlePart(t);t.emit("data",new Buffer("hello"));t.emit("data",new Buffer(" world: "));t.emit("data",new Buffer([226]));t.emit("data",new Buffer([130,172]));t.emit("end")})();(function(){form.maxFieldsSize=8;var t=new events.EventEmitter;t.name="my_field";gently.expect(form,"_error",function(e){assert.equal(e.message,"maxFieldsSize exceeded, received 9 bytes of field data")});form.handlePart(t);form._fieldsSize=1;t.emit("data",new Buffer(7));t.emit("data",new Buffer(1))})();(function(){var t=new events.EventEmitter,n=new events.EventEmitter,r="/foo/bar";t.name="my_file";t.filename="sweet.txt";t.mime="sweet.txt";gently.expect(form,"_uploadPath",function(e){assert.equal(e,t.filename);return r});gently.expect(FileStub,"new",function(e){assert.equal(e.path,r);assert.equal(e.name,t.filename);assert.equal(e.type,t.mime);n=this;gently.expect(form,"emit",function(e,r,i){assert.equal(e,"fileBegin");assert.strictEqual(r,t.name);assert.strictEqual(i,n)});gently.expect(n,"open")});form.handlePart(t);assert.equal(form._flushing,1);var i;gently.expect(form,"pause");gently.expect(n,"write",function(e,t){assert.strictEqual(e,i);gently.expect(form,"resume");t()});t.emit("data",i=new Buffer("test"));gently.expect(n,"end",function(e){gently.expect(form,"emit",function(e,t,r){assert.equal(e,"file");assert.strictEqual(r,n)});gently.expect(form,"_maybeEnd");e();assert.equal(form._flushing,0)});t.emit("end")})()});test(function(){(function(){var t,n;gently.expect(GENTLY.hijacked.path,"join",function(e,n){assert.equal(e,form.uploadDir);t=n});form._uploadPath();gently.expect(GENTLY.hijacked.path,"join",function(e,t){n=t});form._uploadPath();assert.notEqual(t,n)})();(function(){form.keepExtensions=!0;var t="foo.jpg",n=".bar";gently.expect(GENTLY.hijacked.path,"extname",function(e){assert.equal(e,t);gently.restore(path,"extname");return n});gently.expect(GENTLY.hijacked.path,"join",function(e,t){assert.equal(path.extname(t),n)});form._uploadPath(t)})()});test(function(){gently.expect(form,"emit",0);form._maybeEnd();form.ended=!0;form._flushing=1;form._maybeEnd();gently.expect(form,"emit",function(e){assert.equal(e,"end")});form.ended=!0;form._flushing=0;form._maybeEnd()});