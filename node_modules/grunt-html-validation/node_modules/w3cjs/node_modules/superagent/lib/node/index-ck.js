/**
 * Module dependencies.
 */function noop(){}function isObject(e){return null!=e&&"object"==typeof e}function Request(e,t){var n=this;"string"!=typeof t&&(t=format(t));this._agent=!1;this.method=e;this.url=t;this.header={};this.writable=!0;this._redirects=0;this.redirects(5);this.attachments=[];this.cookies="";this._redirectList=[];this.on("end",this.clearTimeout.bind(this));this.on("response",function(e){n.callback(null,e)})}function request(e,t){return"function"==typeof t?(new Request("GET",e)).end(t):1==arguments.length?new Request("GET",e):new Request(e,t)}function isText(e){var t=e.split("/"),n=t[0],r=t[1];return"text"==n||"json"==r||"x-www-form-urlencoded"==r}function isRedirect(e){return~[301,302,303,305,307].indexOf(e)}var debug=require("debug")("superagent"),formidable=require("formidable"),Response=require("./response"),parse=require("url").parse,format=require("url").format,methods=require("methods"),Stream=require("stream"),utils=require("./utils"),Part=require("./part"),mime=require("mime"),https=require("https"),http=require("http"),fs=require("fs"),qs=require("qs"),zlib=require("zlib"),util=require("util");exports=module.exports=request;exports.agent=require("./agent");exports.Part=Part;exports.Response=Response;mime.define({"application/x-www-form-urlencoded":["form","urlencoded","form-data"]});exports.protocols={"http:":http,"https:":https};exports.serialize={"application/x-www-form-urlencoded":qs.stringify,"application/json":JSON.stringify};exports.parse=require("./parsers");Request.prototype.__proto__=Stream.prototype;Request.prototype.attach=function(e,t,n){debug("attach %s %s",e,t);this.attachments.push({field:e,path:t,part:new Part(this),filename:n||t});return this};Request.prototype.redirects=function(e){debug("max redirects %s",e);this._maxRedirects=e;return this};Request.prototype.part=function(){return new Part(this)};Request.prototype.agent=function(e){e&&(this._agent=e);return this._agent};Request.prototype.set=function(e,t){if(isObject(e)){for(var n in e)this.set(n,e[n]);return this}debug('set %s "%s"',e,t);this.request().setHeader(e,t);return this};Request.prototype.get=function(e){return this.request().getHeader(e)};Request.prototype.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:mime.lookup(e))};Request.prototype.query=function(e){var t=this.request();"string"!=typeof e&&(e=qs.stringify(e));if(!e.length)return this;debug("query %s",e);t.path+=(~t.path.indexOf("?")?"&":"?")+e;return this};Request.prototype.send=function(e){var t=isObject(e),n=this.request(),r=n.getHeader("Content-Type");if(t&&isObject(this._data))for(var i in e)this._data[i]=e[i];else if("string"==typeof e){r||this.type("form");r=n.getHeader("Content-Type");"application/x-www-form-urlencoded"==r?this._data=this._data?this._data+"&"+e:e:this._data=(this._data||"")+e}else this._data=e;if(!t)return this;r||this.type("json");return this};Request.prototype.write=function(e,t){return this.request().write(e,t)};Request.prototype.pipe=function(e,t){this.piped=!0;this.buffer(!1);this.end().req.on("response",function(n){/^(deflate|gzip)$/.test(n.headers["content-encoding"])?n.pipe(zlib.createUnzip()).pipe(e,t):n.pipe(e,t)});return e};Request.prototype.buffer=function(e){this._buffer=!1===e?!1:!0;return this};Request.prototype.timeout=function(e){this._timeout=e;return this};Request.prototype.clearTimeout=function(){debug("clear timeout %s %s",this.method,this.url);this._timeout=0;clearTimeout(this._timer);return this};Request.prototype.abort=function(){debug("abort %s %s",this.method,this.url);this._aborted=!0;this.clearTimeout();this.req.abort()};Request.prototype.parse=function(e){this._parser=e;return this};Request.prototype.redirect=function(e){var t=e.headers.location;debug("redirect %s -> %s",this.url,t);if(!~t.indexOf("://")){0!=t.indexOf("//")&&(t="//"+this.host+t);t=this.protocol+t}e.resume();var n=utils.cleanHeader(this.req._headers);delete this.req;this.method="HEAD"==this.method?"HEAD":"GET";this._data=null;this.url=t;this._redirectList.push(t);this.clearTimeout();this.emit("redirect",e);this.set(n);this.end(this._callback);return this};Request.prototype.auth=function(e,t){var n=(new Buffer(e+":"+t)).toString("base64");return this.set("Authorization","Basic "+n)};Request.prototype.field=function(e,t){this.part().name(e).write(String(t));return this};Request.prototype.request=function(){if(this.req)return this.req;var e=this,t={},n=this._data,r=this.url;0!=r.indexOf("http")&&(r="http://"+r);r=parse(r,!0);t.method=this.method;t.port=r.port;t.path=r.pathname;t.host=r.hostname;t.agent=this._agent;var i=exports.protocols[r.protocol],s=this.req=i.request(t);"HEAD"!=t.method&&s.setHeader("Accept-Encoding","gzip, deflate");this.protocol=r.protocol;this.host=r.host;s.on("drain",function(){e.emit("drain")});s.on("error",function(t){if(e._aborted)return;e.callback(t)});if(r.auth){var o=r.auth.split(":");this.auth(o[0],o[1])}this.query(r.query);s.setHeader("Cookie",this.cookies);return s};Request.prototype.callback=function(e,t){var n=this._callback;this.clearTimeout();if(this.called)return console.warn("double callback!");this.called=!0;if(2==n.length)return n(e,t);if(e)return this.emit("error",e);n(t)};Request.prototype.end=function(e){var t=this,n=this._data,r=this.request(),i=this._buffer,s=this.method,o=this._timeout;debug("%s %s",this.method,this.url);this._callback=e||noop;if(o&&!this._timer){debug("timeout %sms %s %s",o,this.method,this.url);this._timer=setTimeout(function(){var e=new Error("timeout of "+o+"ms exceeded");e.timeout=o;t.abort();t.callback(e)},o)}if("HEAD"!=s&&!r._headerSent){if("string"!=typeof n){var u=exports.serialize[r.getHeader("Content-Type")];u&&(n=u(n))}n&&!r.getHeader("Content-Length")&&this.set("Content-Length",Buffer.byteLength(n))}r.on("response",function(e){debug("%s %s -> %s",t.method,t.url,e.statusCode);var n=t._maxRedirects,s=utils.type(e.headers["content-type"]||""),o=e.headers["content-length"],u=s.split("/"),a=u[1],u=u[0],f="multipart"==u,l=isRedirect(e.statusCode);if(t.piped){e.on("end",function(){t.emit("end")});return}if(l&&t._redirects++!=n)return t.redirect(e);/^(deflate|gzip)$/.test(e.headers["content-encoding"])&&utils.unzip(r,e);f&&(i=!1);if(f){var c=new formidable.IncomingForm;c.parse(e,function(n,i,s){if(n)return t.callback(n);var o=new Response(r,e);o.body=i;o.files=s;o.redirects=t._redirectList;t.emit("end");t.callback(null,o)});return}var h=isText(s);null==i&&h&&(i=!0);var p="text"==u?exports.parse.text:exports.parse[s];i&&(p=p||exports.parse.text);t._parser&&(p=t._parser);p&&p(e,function(t,n){e.body=n});if(!i){debug("unbuffered %s %s",t.method,t.url);t.res=e;var d=new Response(t.req,t.res);d.redirects=t._redirectList;t.emit("response",d);if(f)return;e.on("end",function(){debug("end %s %s",t.method,t.url);t.emit("end")});return}t.res=e;e.on("end",function(){debug("end %s %s",t.method,t.url);var e=new Response(t.req,t.res);e.redirects=t._redirectList;t.emit("response",e);t.emit("end")})});if(this.attachments.length)return this.writeAttachments();this._boundary&&this.writeFinalBoundary();r.end(n);return this};Request.prototype.writeFinalBoundary=function(){this.request().write("\r\n--"+this._boundary+"--")};Request.prototype.attachmentSize=function(e){var t=this.attachments,n=t.length,r=0,i=this;t.forEach(function(t){fs.stat(t.path,function(t,i){i&&(r+=i.size);--n||e(r)})})};Request.prototype.writeAttachments=function(){var e=this.attachments,t=this.request(),n=0,r=this;this.attachmentSize(function(i){function s(){var o=e.shift();if(!o){r.writeFinalBoundary();return t.end()}o.part.attachment(o.field,o.filename);var u=fs.createReadStream(o.path);u.on("data",function(e){n+=e.length;o.part.write(e);r.emit("progress",{percent:n/i*100|0,written:n,total:i})}).on("error",function(e){r.emit("error",e)}).on("end",s)}s()})};exports.Request=Request;methods.forEach(function(e){var t="delete"==e?"del":e;e=e.toUpperCase();request[t]=function(t,n){var r=request(e,t);n&&r.end(n);return r}});