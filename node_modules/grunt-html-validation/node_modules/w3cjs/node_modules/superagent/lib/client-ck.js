/**
 * Module dependencies.
 */function noop(){}function isHost(e){var t={}.toString.call(e);switch(t){case"[object File]":case"[object Blob]":case"[object FormData]":return!0;default:return!1}}function getXHR(){if(root.XMLHttpRequest&&("file:"!=root.location.protocol||!root.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}return!1}function isObject(e){return e===Object(e)}function serialize(e){if(!isObject(e))return e;var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function parseString(e){var t={},n=e.split("&"),r,i;for(var s=0,o=n.length;s<o;++s){i=n[s];r=i.split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return t}function parseHeader(e){var t=e.split(/\r?\n/),n={},r,i,s,o;t.pop();for(var u=0,a=t.length;u<a;++u){i=t[u];r=i.indexOf(":");s=i.slice(0,r).toLowerCase();o=trim(i.slice(r+1));n[s]=o}return n}function type(e){return e.split(/ *; */).shift()}function params(e){return reduce(e.split(/ *; */),function(e,t){var n=t.split(/ *= */),r=n.shift(),i=n.shift();r&&i&&(e[r]=i);return e},{})}function Response(e,t){t=t||{};this.req=e;this.xhr=this.req.xhr;this.text=this.xhr.responseText;this.setStatusProperties(this.xhr.status);this.header=this.headers=parseHeader(this.xhr.getAllResponseHeaders());this.header["content-type"]=this.xhr.getResponseHeader("content-type");this.setHeaderProperties(this.header);this.body=this.parseBody(this.text)}function Request(e,t){var n=this;Emitter.call(this);this._query=this._query||[];this.method=e;this.url=t;this.header={};this._header={};this.on("end",function(){var t=new Response(n);"HEAD"==e&&(t.text=null);n.callback(null,t)})}function request(e,t){return"function"==typeof t?(new Request("GET",e)).end(t):1==arguments.length?new Request("GET",e):new Request(e,t)}var Emitter=require("emitter"),reduce=require("reduce"),root="undefined"==typeof window?this:window,trim="".trim?function(e){return e.trim()}:function(e){return e.replace(/(^\s*|\s*$)/g,"")};request.serializeObject=serialize;request.parseString=parseString;request.types={html:"text/html",json:"application/json",urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"};request.serialize={"application/x-www-form-urlencoded":serialize,"application/json":JSON.stringify};request.parse={"application/x-www-form-urlencoded":parseString,"application/json":JSON.parse};Response.prototype.get=function(e){return this.header[e.toLowerCase()]};Response.prototype.setHeaderProperties=function(e){var t=this.header["content-type"]||"";this.type=type(t);var n=params(t);for(var r in n)this[r]=n[r]};Response.prototype.parseBody=function(e){var t=request.parse[this.type];return t?t(e):null};Response.prototype.setStatusProperties=function(e){var t=e/100|0;this.status=e;this.statusType=t;this.info=1==t;this.ok=2==t;this.clientError=4==t;this.serverError=5==t;this.error=4==t||5==t?this.toError():!1;this.accepted=202==e;this.noContent=204==e||1223==e;this.badRequest=400==e;this.unauthorized=401==e;this.notAcceptable=406==e;this.notFound=404==e;this.forbidden=403==e};Response.prototype.toError=function(){var e=this.req,t=e.method,n=e.path,r="cannot "+t+" "+n+" ("+this.status+")",i=new Error(r);i.status=this.status;i.method=t;i.path=n;return i};request.Response=Response;Emitter(Request.prototype);Request.prototype.timeout=function(e){this._timeout=e;return this};Request.prototype.clearTimeout=function(){this._timeout=0;clearTimeout(this._timer);return this};Request.prototype.abort=function(){if(this.aborted)return;this.aborted=!0;this.xhr.abort();this.clearTimeout();this.emit("abort");return this};Request.prototype.set=function(e,t){if(isObject(e)){for(var n in e)this.set(n,e[n]);return this}this._header[e.toLowerCase()]=t;this.header[e]=t;return this};Request.prototype.getHeader=function(e){return this._header[e.toLowerCase()]};Request.prototype.type=function(e){this.set("Content-Type",request.types[e]||e);return this};Request.prototype.auth=function(e,t){var n=btoa(e+":"+t);this.set("Authorization","Basic "+n);return this};Request.prototype.query=function(e){"string"!=typeof e&&(e=serialize(e));e&&this._query.push(e);return this};Request.prototype.send=function(e){var t=isObject(e),n=this.getHeader("Content-Type");if(t&&isObject(this._data))for(var r in e)this._data[r]=e[r];else if("string"==typeof e){n||this.type("form");n=this.getHeader("Content-Type");"application/x-www-form-urlencoded"==n?this._data=this._data?this._data+"&"+e:e:this._data=(this._data||"")+e}else this._data=e;if(!t)return this;n||this.type("json");return this};Request.prototype.callback=function(e,t){var n=this._callback;if(2==n.length)return n(e,t);if(e)return this.emit("error",e);n(t)};Request.prototype.crossDomainError=function(){var e=new Error("Origin is not allowed by Access-Control-Allow-Origin");e.crossDomain=!0;this.callback(e)};Request.prototype.timeoutError=function(){var e=this._timeout,t=new Error("timeout of "+e+"ms exceeded");t.timeout=e;this.callback(t)};Request.prototype.withCredentials=function(){this._withCredentials=!0;return this};Request.prototype.end=function(e){var t=this,n=this.xhr=getXHR(),r=this._query.join("&"),i=this._timeout,s=this._data;this._callback=e||noop;this._withCredentials&&(n.withCredentials=!0);n.onreadystatechange=function(){if(4!=n.readyState)return;if(0==n.status)return t.aborted?t.timeoutError():t.crossDomainError();t.emit("end")};n.upload&&(n.upload.onprogress=function(e){e.percent=e.loaded/e.total*100;t.emit("progress",e)});i&&!this._timer&&(this._timer=setTimeout(function(){t.abort()},i));if(r){r=request.serializeObject(r);this.url+=~this.url.indexOf("?")?"&"+r:"?"+r}n.open(this.method,this.url,!0);if("GET"!=this.method&&"HEAD"!=this.method&&"string"!=typeof s&&!isHost(s)){var o=request.serialize[this.getHeader("Content-Type")];o&&(s=o(s))}for(var u in this.header){if(null==this.header[u])continue;n.setRequestHeader(u,this.header[u])}n.send(s);return this};request.Request=Request;request.get=function(e,t,n){var r=request("GET",e);"function"==typeof t&&(n=t,t=null);t&&r.query(t);n&&r.end(n);return r};request.head=function(e,t,n){var r=request("HEAD",e);"function"==typeof t&&(n=t,t=null);t&&r.send(t);n&&r.end(n);return r};request.del=function(e,t){var n=request("DELETE",e);t&&n.end(t);return n};request.patch=function(e,t,n){var r=request("PATCH",e);"function"==typeof t&&(n=t,t=null);t&&r.send(t);n&&r.end(n);return r};request.post=function(e,t,n){var r=request("POST",e);"function"==typeof t&&(n=t,t=null);t&&r.send(t);n&&r.end(n);return r};request.put=function(e,t,n){var r=request("PUT",e);"function"==typeof t&&(n=t,t=null);t&&r.send(t);n&&r.end(n);return r};module.exports=request;