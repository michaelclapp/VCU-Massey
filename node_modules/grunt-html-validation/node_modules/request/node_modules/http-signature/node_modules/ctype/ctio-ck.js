/*
 * rm - Feb 2011
 * ctio.js:
 *
 * A simple way to read and write simple ctypes. Of course, as you'll find the
 * code isn't as simple as it might appear. The following types are currently
 * supported in big and little endian formats:
 *
 * 	uint8_t			int8_t
 * 	uint16_t		int16_t
 * 	uint32_t		int32_t
 *	float (single precision IEEE 754)
 *	double (double precision IEEE 754)
 *
 * This is designed to work in Node and v8. It may in fact work in other
 * Javascript interpreters (that'd be pretty neat), but it hasn't been tested.
 * If you find that it does in fact work, that's pretty cool. Try and pass word
 * back to the original author.
 *
 * Note to the reader: If you're tabstop isn't set to 8, parts of this may look
 * weird.
 *//*
 * Numbers in Javascript have a secret: all numbers must be represented with an
 * IEEE-754 double. The double has a mantissa with a length of 52 bits with an
 * implicit one. Thus the range of integers that can be represented is limited
 * to the size of the mantissa, this makes reading and writing 64-bit integers
 * difficult, but far from impossible.
 *
 * Another side effect of this representation is what happens when you use the
 * bitwise operators, i.e. shift left, shift right, and, or, etc. In Javascript,
 * each operand and the result is cast to a signed 32-bit number. However, in
 * the case of >>> the values are cast to an unsigned number.
 *//*
 * A reminder on endian related issues:
 *
 * Big Endian: MSB -> First byte
 * Little Endian: MSB->Last byte
 */function ruint8(e,t,n){if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n>=e.length)throw new Error("Trying to read beyond buffer length");return e[n]}function rgint16(e,t,n){var r=0;if(t=="big"){r=e[n]<<8;r|=e[n+1]}else{r=e[n];r|=e[n+1]<<8}return r}function ruint16(e,t,n){if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+1>=e.length)throw new Error("Trying to read beyond buffer length");return rgint16(e,t,n)}function rgint32(e,t,n){var r=0;if(t=="big"){r=e[n+1]<<16;r|=e[n+2]<<8;r|=e[n+3];r+=e[n]<<24>>>0}else{r=e[n+2]<<16;r|=e[n+1]<<8;r|=e[n];r+=e[n+3]<<24>>>0}return r}function ruint32(e,t,n){if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+3>=e.length)throw new Error("Trying to read beyond buffer length");return rgint32(e,t,n)}function rgint64(e,t,n){var r=new Array(2);if(t=="big"){r[0]=ruint32(e,t,n);r[1]=ruint32(e,t,n+4)}else{r[0]=ruint32(e,t,n+4);r[1]=ruint32(e,t,n)}return r}function ruint64(e,t,n){if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+7>=e.length)throw new Error("Trying to read beyond buffer length");return rgint64(e,t,n)}function rsint8(e,t,n){var r;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n>=e.length)throw new Error("Trying to read beyond buffer length");r=e[n]&128;return r?(255-e[n]+1)*-1:e[n]}function rsint16(e,t,n){var r,i;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+1>=e.length)throw new Error("Trying to read beyond buffer length");i=rgint16(e,t,n);r=i&32768;return r?(65535-i+1)*-1:i}function rsint32(e,t,n){var r,i;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+3>=e.length)throw new Error("Trying to read beyond buffer length");i=rgint32(e,t,n);r=i&2147483648;return r?(4294967295-i+1)*-1:i}function rsint64(e,t,n){var r,i;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+3>=e.length)throw new Error("Trying to read beyond buffer length");i=rgint64(e,t,n);r=i[0]&2147483648;if(!r)return i;i[0]=(4294967295-i[0])*-1;i[1]=(4294967295-i[1]+1)*-1;mod_assert.ok(i[1]<=4294967296);if(i[1]==-4294967296){i[1]=0;i[0]--}return i}function rfloat(e,t,n){var r=[],i,s,o,u,a=127,f=255;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+3>=e.length)throw new Error("Trying to read beyond buffer length");if(t=="big"){r[0]=e[n];r[1]=e[n+1];r[2]=e[n+2];r[3]=e[n+3]}else{r[3]=e[n];r[2]=e[n+1];r[1]=e[n+2];r[0]=e[n+3]}i=r[0]&128;s=(r[0]&127)<<1;s|=(r[1]&128)>>>7;o=(r[1]&127)<<16;o|=r[2]<<8;o|=r[3];if(!i&&s==f&&o===0)return Number.POSITIVE_INFINITY;if(i&&s==f&&o===0)return Number.NEGATIVE_INFINITY;if(s==f&&o!==0)return Number.NaN;if(s===0&&o===0)return 0;s-=a;if(s==-a){s++;u=0}else u=1;u=(u+o*Math.pow(2,-23))*Math.pow(2,s);i&&(u*=-1);return u}function rdouble(e,t,n){var r=[],i,s,o,u,a,f=1023,l=2047;if(t===undefined)throw new Error("missing endian");if(e===undefined)throw new Error("missing buffer");if(n===undefined)throw new Error("missing offset");if(n+7>=e.length)throw new Error("Trying to read beyond buffer length");if(t=="big"){r[0]=e[n];r[1]=e[n+1];r[2]=e[n+2];r[3]=e[n+3];r[4]=e[n+4];r[5]=e[n+5];r[6]=e[n+6];r[7]=e[n+7]}else{r[7]=e[n];r[6]=e[n+1];r[5]=e[n+2];r[4]=e[n+3];r[3]=e[n+4];r[2]=e[n+5];r[1]=e[n+6];r[0]=e[n+7]}i=r[0]&128;s=(r[0]&127)<<4;s|=(r[1]&240)>>>4;a=r[7];a|=r[6]<<8;a|=r[5]<<16;o=r[4];o|=r[3]<<8;o|=r[2]<<16;o|=(r[1]&15)<<24;o*=Math.pow(2,24);o+=a;if(!i&&s==l&&o===0)return Number.POSITIVE_INFINITY;if(i&&s==l&&o===0)return Number.NEGATIVE_INFINITY;if(s==l&&o!==0)return Number.NaN;if(s===0&&o===0)return 0;s-=f;if(s==-f){s++;u=0}else u=1;u=(u+o*Math.pow(2,-52))*Math.pow(2,s);i&&(u*=-1);return u}function prepuint(e,t){if(typeof e!="number")throw new(Error("cannot write a non-number as a number"));if(e<0)throw new Error("specified a negative value for writing an unsigned value");if(e>t)throw new Error("value is larger than maximum value for type");if(Math.floor(e)!==e)throw new Error("value has a fractional component");return e}function wuint8(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r>=n.length)throw new Error("Trying to read beyond buffer length");i=prepuint(e,255);n[r]=i}function wgint16(e,t,n,r){if(t=="big"){n[r]=(e&65280)>>>8;n[r+1]=e&255}else{n[r+1]=(e&65280)>>>8;n[r]=e&255}}function wuint16(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+1>=n.length)throw new Error("Trying to read beyond buffer length");i=prepuint(e,65535);wgint16(i,t,n,r)}function wgint32(e,t,n,r){if(t=="big"){n[r]=(e-(e&16777215))/Math.pow(2,24);n[r+1]=e>>>16&255;n[r+2]=e>>>8&255;n[r+3]=e&255}else{n[r+3]=(e-(e&16777215))/Math.pow(2,24);n[r+2]=e>>>16&255;n[r+1]=e>>>8&255;n[r]=e&255}}function wuint32(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+3>=n.length)throw new Error("Trying to read beyond buffer length");i=prepuint(e,4294967295);wgint32(i,t,n,r)}function wgint64(e,t,n,r){if(t=="big"){wgint32(e[0],t,n,r);wgint32(e[1],t,n,r+4)}else{wgint32(e[0],t,n,r+4);wgint32(e[1],t,n,r)}}function wuint64(e,t,n,r){if(e===undefined)throw new Error("missing value");if(!(e instanceof Array))throw new Error("value must be an array");if(e.length!=2)throw new Error("value must be an array of length 2");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+7>=n.length)throw new Error("Trying to read beyond buffer length");prepuint(e[0],4294967295);prepuint(e[1],4294967295);wgint64(e,t,n,r)}function prepsint(e,t,n){if(typeof e!="number")throw new(Error("cannot write a non-number as a number"));if(e>t)throw new Error("value larger than maximum allowed value");if(e<n)throw new Error("value smaller than minimum allowed value");if(Math.floor(e)!==e)throw new Error("value has a fractional component");return e}function wsint8(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r>=n.length)throw new Error("Trying to read beyond buffer length");i=prepsint(e,127,-128);i>=0?wuint8(i,t,n,r):wuint8(255+i+1,t,n,r)}function wsint16(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+1>=n.length)throw new Error("Trying to read beyond buffer length");i=prepsint(e,32767,-32768);i>=0?wgint16(i,t,n,r):wgint16(65535+i+1,t,n,r)}function wsint32(e,t,n,r){var i;if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+3>=n.length)throw new Error("Trying to read beyond buffer length");i=prepsint(e,2147483647,-2147483648);i>=0?wgint32(i,t,n,r):wgint32(4294967295+i+1,t,n,r)}function wsint64(e,t,n,r){var i,s,o=new Array(2);if(e===undefined)throw new Error("missing value");if(!(e instanceof Array))throw new Error("value must be an array");if(e.length!=2)throw new Error("value must be an array of length 2");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+7>=n.length)throw new Error("Trying to read beyond buffer length");i=e[0]*Number.POSITIVE_INFINITY==Number.POSITIVE_INFINITY;s=e[1]*Number.POSITIVE_INFINITY==Number.POSITIVE_INFINITY;if(e[0]!=0&&e[1]!=0&&i!=s)throw new Error("Both entries in the array must have the same sign");if(i){prepuint(e[0],2147483647);prepuint(e[1],4294967295)}else{prepsint(e[0],0,-2147483648);prepsint(e[1],0,-4294967295);if(e[0]==-2147483648&&e[1]!=0)throw new Error("value smaller than minimum allowed value")}if(e[0]<0||e[1]<0){o[0]=4294967295-Math.abs(e[0]);o[1]=4294967296-Math.abs(e[1]);if(o[1]==4294967296){o[1]=0;o[0]++}}else{o[0]=e[0];o[1]=e[1]}wgint64(o,t,n,r)}function log2(e){return Math.log(e)/Math.log(2)}function intexp(e){return Math.floor(log2(e))}function fracexp(e){return Math.floor(log2(e))}function wfloat(e,t,n,r){var i,s,o,u,a=[];if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+3>=n.length)throw new Error("Trying to read beyond buffer length");if(isNaN(e)){i=0;s=255;o=23}else if(e==Number.POSITIVE_INFINITY){i=0;s=255;o=0}else if(e==Number.NEGATIVE_INFINITY){i=1;s=255;o=0}else{if(e<0){i=1;e=Math.abs(e)}else i=0;e<1?u=fracexp(e):u=intexp(e);if(u<=-127){s=0;o=e*Math.pow(2,149)&8388607}else{s=127+u;o=e*Math.pow(2,23-u);o&=8388607}}a[0]=i<<7|(s&254)>>>1;a[1]=(s&1)<<7|(o&8323072)>>>16;a[2]=(o&65280)>>>8;a[3]=o&255;if(t=="big"){n[r]=a[0];n[r+1]=a[1];n[r+2]=a[2];n[r+3]=a[3]}else{n[r]=a[3];n[r+1]=a[2];n[r+2]=a[1];n[r+3]=a[0]}}function wdouble(e,t,n,r){var i,s,o,u,a=[];if(e===undefined)throw new Error("missing value");if(t===undefined)throw new Error("missing endian");if(n===undefined)throw new Error("missing buffer");if(r===undefined)throw new Error("missing offset");if(r+7>=n.length)throw new Error("Trying to read beyond buffer length");if(isNaN(e)){i=0;s=2047;o=23}else if(e==Number.POSITIVE_INFINITY){i=0;s=2047;o=0}else if(e==Number.NEGATIVE_INFINITY){i=1;s=2047;o=0}else{if(e<0){i=1;e=Math.abs(e)}else i=0;e<1?u=fracexp(e):u=intexp(e);if(e<=2.225073858507201e-308||u<=-1023){s=0;o=e*Math.pow(2,1023)*Math.pow(2,51);o%=Math.pow(2,52)}else{u>1023&&(u=1023);s=1023+u;o=e*Math.pow(2,-u);o*=Math.pow(2,52);o%=Math.pow(2,52)}}a[7]=o&255;a[6]=o>>>8&255;a[5]=o>>>16&255;o=(o-(o&16777215))/Math.pow(2,24);a[4]=o&255;a[3]=o>>>8&255;a[2]=o>>>16&255;a[1]=(s&15)<<4|o>>>24;a[0]=i<<7|(s&2032)>>>4;if(t=="big"){n[r]=a[0];n[r+1]=a[1];n[r+2]=a[2];n[r+3]=a[3];n[r+4]=a[4];n[r+5]=a[5];n[r+6]=a[6];n[r+7]=a[7]}else{n[r+7]=a[0];n[r+6]=a[1];n[r+5]=a[2];n[r+4]=a[3];n[r+3]=a[4];n[r+2]=a[5];n[r+1]=a[6];n[r]=a[7]}}var mod_assert=require("assert");exports.ruint8=ruint8;exports.ruint16=ruint16;exports.ruint32=ruint32;exports.ruint64=ruint64;exports.wuint8=wuint8;exports.wuint16=wuint16;exports.wuint32=wuint32;exports.wuint64=wuint64;exports.rsint8=rsint8;exports.rsint16=rsint16;exports.rsint32=rsint32;exports.rsint64=rsint64;exports.wsint8=wsint8;exports.wsint16=wsint16;exports.wsint32=wsint32;exports.wsint64=wsint64;exports.rfloat=rfloat;exports.rdouble=rdouble;exports.wfloat=wfloat;exports.wdouble=wdouble;