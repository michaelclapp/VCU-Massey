// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.
var test=require("tap").test,sys=require("sys"),BerWriter,BerReader;test("load library",function(e){BerWriter=require("../../lib/index").BerWriter;e.ok(BerWriter);e.ok(new BerWriter);e.end()});test("write byte",function(e){var t=new BerWriter;t.writeByte(194);var n=t.buffer;e.ok(n);e.equal(n.length,1,"Wrong length");e.equal(n[0],194,"value wrong");e.end()});test("write 1 byte int",function(e){var t=new BerWriter;t.writeInt(127);var n=t.buffer;e.ok(n);e.equal(n.length,3,"Wrong length for an int: "+n.length);e.equal(n[0],2,"ASN.1 tag wrong (2) -> "+n[0]);e.equal(n[1],1,"length wrong(1) -> "+n[1]);e.equal(n[2],127,"value wrong(3) -> "+n[2]);e.end()});test("write 2 byte int",function(e){var t=new BerWriter;t.writeInt(32766);var n=t.buffer;e.ok(n);e.equal(n.length,4,"Wrong length for an int");e.equal(n[0],2,"ASN.1 tag wrong");e.equal(n[1],2,"length wrong");e.equal(n[2],127,"value wrong (byte 1)");e.equal(n[3],254,"value wrong (byte 2)");e.end()});test("write 3 byte int",function(e){var t=new BerWriter;t.writeInt(8388606);var n=t.buffer;e.ok(n);e.equal(n.length,5,"Wrong length for an int");e.equal(n[0],2,"ASN.1 tag wrong");e.equal(n[1],3,"length wrong");e.equal(n[2],127,"value wrong (byte 1)");e.equal(n[3],255,"value wrong (byte 2)");e.equal(n[4],254,"value wrong (byte 3)");e.end()});test("write 4 byte int",function(e){var t=new BerWriter;t.writeInt(2147483646);var n=t.buffer;e.ok(n);e.equal(n.length,6,"Wrong length for an int");e.equal(n[0],2,"ASN.1 tag wrong");e.equal(n[1],4,"length wrong");e.equal(n[2],127,"value wrong (byte 1)");e.equal(n[3],255,"value wrong (byte 2)");e.equal(n[4],255,"value wrong (byte 3)");e.equal(n[5],254,"value wrong (byte 4)");e.end()});test("write boolean",function(e){var t=new BerWriter;t.writeBoolean(!0);t.writeBoolean(!1);var n=t.buffer;e.ok(n);e.equal(n.length,6,"Wrong length");e.equal(n[0],1,"tag wrong");e.equal(n[1],1,"length wrong");e.equal(n[2],255,"value wrong");e.equal(n[3],1,"tag wrong");e.equal(n[4],1,"length wrong");e.equal(n[5],0,"value wrong");e.end()});test("write string",function(e){var t=new BerWriter;t.writeString("hello world");var n=t.buffer;e.ok(n);e.equal(n.length,13,"wrong length");e.equal(n[0],4,"wrong tag");e.equal(n[1],11,"wrong length");e.equal(n.slice(2).toString("utf8"),"hello world","wrong value");e.end()});test("write buffer",function(e){var t=new BerWriter;t.writeString("hello world");var n=t.buffer,r=new Buffer([4,11,48,9,2,1,15,1,1,255,1,1,255]);t.writeBuffer(r.slice(2,r.length),4);n=t.buffer;e.ok(n);e.equal(n.length,26,"wrong length");e.equal(n[0],4,"wrong tag");e.equal(n[1],11,"wrong length");e.equal(n.slice(2,13).toString("utf8"),"hello world","wrong value");e.equal(n[13],r[0],"wrong tag");e.equal(n[14],r[1],"wrong length");for(var i=13,s=0;i<n.length&&s<r.length;i++,s++)e.equal(n[i],r[s],"buffer contents not identical");e.end()});test("write string array",function(e){var t=new BerWriter;t.writeStringArray(["hello world","fubar!"]);var n=t.buffer;e.ok(n);e.equal(n.length,21,"wrong length");e.equal(n[0],4,"wrong tag");e.equal(n[1],11,"wrong length");e.equal(n.slice(2,13).toString("utf8"),"hello world","wrong value");e.equal(n[13],4,"wrong tag");e.equal(n[14],6,"wrong length");e.equal(n.slice(15).toString("utf8"),"fubar!","wrong value");e.end()});test("resize internal buffer",function(e){var t=new BerWriter({size:2});t.writeString("hello world");var n=t.buffer;e.ok(n);e.equal(n.length,13,"wrong length");e.equal(n[0],4,"wrong tag");e.equal(n[1],11,"wrong length");e.equal(n.slice(2).toString("utf8"),"hello world","wrong value");e.end()});test("sequence",function(e){var t=new BerWriter({size:25});t.startSequence();t.writeString("hello world");t.endSequence();var n=t.buffer;e.ok(n);console.log(n);e.equal(n.length,15,"wrong length");e.equal(n[0],48,"wrong tag");e.equal(n[1],13,"wrong length");e.equal(n[2],4,"wrong tag");e.equal(n[3],11,"wrong length");e.equal(n.slice(4).toString("utf8"),"hello world","wrong value");e.end()});test("nested sequence",function(e){var t=new BerWriter({size:25});t.startSequence();t.writeString("hello world");t.startSequence();t.writeString("hello world");t.endSequence();t.endSequence();var n=t.buffer;e.ok(n);e.equal(n.length,30,"wrong length");e.equal(n[0],48,"wrong tag");e.equal(n[1],28,"wrong length");e.equal(n[2],4,"wrong tag");e.equal(n[3],11,"wrong length");e.equal(n.slice(4,15).toString("utf8"),"hello world","wrong value");e.equal(n[15],48,"wrong tag");e.equal(n[16],13,"wrong length");e.equal(n[17],4,"wrong tag");e.equal(n[18],11,"wrong length");e.equal(n.slice(19,30).toString("utf8"),"hello world","wrong value");e.end()});test("LDAP bind message",function(e){var t="cn=foo,ou=unit,o=test",n=new BerWriter;n.startSequence();n.writeInt(3);n.startSequence(96);n.writeInt(3);n.writeString(t);n.writeByte(128);n.writeByte(0);n.endSequence();n.endSequence();var r=n.buffer;e.ok(r);e.equal(r.length,35,"wrong length (buffer)");e.equal(r[0],48,"wrong tag");e.equal(r[1],33,"wrong length");e.equal(r[2],2,"wrong tag");e.equal(r[3],1,"wrong length");e.equal(r[4],3,"wrong value");e.equal(r[5],96,"wrong tag");e.equal(r[6],28,"wrong length");e.equal(r[7],2,"wrong tag");e.equal(r[8],1,"wrong length");e.equal(r[9],3,"wrong value");e.equal(r[10],4,"wrong tag");e.equal(r[11],t.length,"wrong length");e.equal(r.slice(12,33).toString("utf8"),t,"wrong value");e.equal(r[33],128,"wrong tag");e.equal(r[34],0,"wrong len");e.end()});test("Write OID",function(e){var t="1.2.840.113549.1.1.1",n=new BerWriter;n.writeOID(t);var r=n.buffer;e.ok(r);console.log(require("util").inspect(r));console.log(require("util").inspect(new Buffer([6,9,42,134,72,134,247,13,1,1,1])));e.end()});