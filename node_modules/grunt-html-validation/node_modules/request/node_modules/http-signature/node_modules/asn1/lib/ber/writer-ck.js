// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.
function merge(e,t){assert.ok(e);assert.equal(typeof e,"object");assert.ok(t);assert.equal(typeof t,"object");var n=Object.getOwnPropertyNames(e);n.forEach(function(n){if(t[n])return;var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r)});return t}function Writer(e){e=merge(DEFAULT_OPTS,e||{});this._buf=new Buffer(e.size||1024);this._size=this._buf.length;this._offset=0;this._options=e;this._seq=[];var t=this;this.__defineGetter__("buffer",function(){if(t._seq.length)throw new InvalidAsn1Error(t._seq.length+" unended sequence(s)");return t._buf.slice(0,t._offset)})}var assert=require("assert"),ASN1=require("./types"),errors=require("./errors"),newInvalidAsn1Error=errors.newInvalidAsn1Error,DEFAULT_OPTS={size:1024,growthFactor:8};Writer.prototype.writeByte=function(e){if(typeof e!="number")throw new TypeError("argument must be a Number");this._ensure(1);this._buf[this._offset++]=e};Writer.prototype.writeInt=function(e,t){if(typeof e!="number")throw new TypeError("argument must be a Number");typeof t!="number"&&(t=ASN1.Integer);var n=4;while(((e&4286578688)===0||(e&4286578688)===4286578688)&&n>1){n--;e<<=8}if(n>4)throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff");this._ensure(2+n);this._buf[this._offset++]=t;this._buf[this._offset++]=n;while(n-->0){this._buf[this._offset++]=(e&4278190080)>>24;e<<=8}};Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null);this.writeByte(0)};Writer.prototype.writeEnumeration=function(e,t){if(typeof e!="number")throw new TypeError("argument must be a Number");typeof t!="number"&&(t=ASN1.Enumeration);return this.writeInt(e,t)};Writer.prototype.writeBoolean=function(e,t){if(typeof e!="boolean")throw new TypeError("argument must be a Boolean");typeof t!="number"&&(t=ASN1.Boolean);this._ensure(3);this._buf[this._offset++]=t;this._buf[this._offset++]=1;this._buf[this._offset++]=e?255:0};Writer.prototype.writeString=function(e,t){if(typeof e!="string")throw new TypeError("argument must be a string (was: "+typeof e+")");typeof t!="number"&&(t=ASN1.OctetString);var n=Buffer.byteLength(e);this.writeByte(t);this.writeLength(n);if(n){this._ensure(n);this._buf.write(e,this._offset);this._offset+=n}};Writer.prototype.writeBuffer=function(e,t){if(typeof t!="number")throw new TypeError("tag must be a number");if(!Buffer.isBuffer(e))throw new TypeError("argument must be a buffer");this.writeByte(t);this.writeLength(e.length);this._ensure(e.length);e.copy(this._buf,this._offset,0,e.length);this._offset+=e.length};Writer.prototype.writeStringArray=function(e){if(!e instanceof Array)throw new TypeError("argument must be an Array[String]");var t=this;e.forEach(function(e){t.writeString(e)})};Writer.prototype.writeOID=function(e,t){function n(e,t){if(t<128)e.push(t);else if(t<16384){e.push(t>>>7|128);e.push(t&127)}else if(t<2097152){e.push(t>>>14|128);e.push((t>>>7|128)&255);e.push(t&127)}else if(t<268435456){e.push(t>>>21|128);e.push((t>>>14|128)&255);e.push((t>>>7|128)&255);e.push(t&127)}else{e.push((t>>>28|128)&255);e.push((t>>>21|128)&255);e.push((t>>>14|128)&255);e.push((t>>>7|128)&255);e.push(t&127)}}if(typeof e!="string")throw new TypeError("argument must be a string");typeof t!="number"&&(t=ASN1.OID);if(!/^([0-9]+\.){3,}[0-9]+$/.test(e))throw new Error("argument is not a valid OID string");var r=e.split("."),i=[];i.push(parseInt(r[0],10)*40+parseInt(r[1],10));r.slice(2).forEach(function(e){n(i,parseInt(e,10))});var s=this;this._ensure(2+i.length);this.writeByte(t);this.writeLength(i.length);i.forEach(function(e){s.writeByte(e)})};Writer.prototype.writeLength=function(e){if(typeof e!="number")throw new TypeError("argument must be a Number");this._ensure(4);if(e<=127)this._buf[this._offset++]=e;else if(e<=255){this._buf[this._offset++]=129;this._buf[this._offset++]=e}else if(e<=65535){this._buf[this._offset++]=130;this._buf[this._offset++]=e>>8;this._buf[this._offset++]=e}else{if(!(e<=16777215))throw new InvalidAsn1ERror("Length too long (> 4 bytes)");this._shift(start,e,1);this._buf[this._offset++]=131;this._buf[this._offset++]=e>>16;this._buf[this._offset++]=e>>8;this._buf[this._offset++]=e}};Writer.prototype.startSequence=function(e){typeof e!="number"&&(e=ASN1.Sequence|ASN1.Constructor);this.writeByte(e);this._seq.push(this._offset);this._ensure(3);this._offset+=3};Writer.prototype.endSequence=function(){var e=this._seq.pop(),t=e+3,n=this._offset-t;if(n<=127){this._shift(t,n,-2);this._buf[e]=n}else if(n<=255){this._shift(t,n,-1);this._buf[e]=129;this._buf[e+1]=n}else if(n<=65535){this._buf[e]=130;this._buf[e+1]=n>>8;this._buf[e+2]=n}else{if(!(n<=16777215))throw new InvalidAsn1Error("Sequence too long");this._shift(t,n,1);this._buf[e]=131;this._buf[e+1]=n>>16;this._buf[e+2]=n>>8;this._buf[e+3]=n}};Writer.prototype._shift=function(e,t,n){assert.ok(e!==undefined);assert.ok(t!==undefined);assert.ok(n);this._buf.copy(this._buf,e+n,e,e+t);this._offset+=n};Writer.prototype._ensure=function(e){assert.ok(e);if(this._size-this._offset<e){var t=this._size*this._options.growthFactor;t-this._offset<e&&(t+=e);var n=new Buffer(t);this._buf.copy(n,0,0,this._offset);this._buf=n;this._size=t}};module.exports=Writer;