// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.
var test=require("tap").test,BerReader;test("load library",function(e){BerReader=require("../../lib/index").BerReader;e.ok(BerReader);try{new BerReader;e.fail("Should have thrown")}catch(t){e.ok(t instanceof TypeError,"Should have been a type error")}e.end()});test("read byte",function(e){var t=new BerReader(new Buffer([222]));e.ok(t);e.equal(t.readByte(),222,"wrong value");e.end()});test("read 1 byte int",function(e){var t=new BerReader(new Buffer([2,1,3]));e.ok(t);e.equal(t.readInt(),3,"wrong value");e.equal(t.length,1,"wrong length");e.end()});test("read 2 byte int",function(e){var t=new BerReader(new Buffer([2,2,126,222]));e.ok(t);e.equal(t.readInt(),32478,"wrong value");e.equal(t.length,2,"wrong length");e.end()});test("read 3 byte int",function(e){var t=new BerReader(new Buffer([2,3,126,222,3]));e.ok(t);e.equal(t.readInt(),8314371,"wrong value");e.equal(t.length,3,"wrong length");e.end()});test("read 4 byte int",function(e){var t=new BerReader(new Buffer([2,4,126,222,3,1]));e.ok(t);e.equal(t.readInt(),2128478977,"wrong value");e.equal(t.length,4,"wrong length");e.end()});test("read boolean true",function(e){var t=new BerReader(new Buffer([1,1,255]));e.ok(t);e.equal(t.readBoolean(),!0,"wrong value");e.equal(t.length,1,"wrong length");e.end()});test("read boolean false",function(e){var t=new BerReader(new Buffer([1,1,0]));e.ok(t);e.equal(t.readBoolean(),!1,"wrong value");e.equal(t.length,1,"wrong length");e.end()});test("read enumeration",function(e){var t=new BerReader(new Buffer([10,1,32]));e.ok(t);e.equal(t.readEnumeration(),32,"wrong value");e.equal(t.length,1,"wrong length");e.end()});test("read string",function(e){var t="cn=foo,ou=unit,o=test",n=new Buffer(t.length+2);n[0]=4;n[1]=Buffer.byteLength(t);n.write(t,2);var r=new BerReader(n);e.ok(r);e.equal(r.readString(),t,"wrong value");e.equal(r.length,t.length,"wrong length");e.end()});test("read sequence",function(e){var t=new BerReader(new Buffer([48,3,1,1,255]));e.ok(t);e.equal(t.readSequence(),48,"wrong value");e.equal(t.length,3,"wrong length");e.equal(t.readBoolean(),!0,"wrong value");e.equal(t.length,1,"wrong length");e.end()});test("anonymous LDAPv3 bind",function(e){var t=new Buffer(14);t[0]=48;t[1]=12;t[2]=2;t[3]=1;t[4]=4;t[5]=96;t[6]=7;t[7]=2;t[8]=1;t[9]=3;t[10]=4;t[11]=0;t[12]=128;t[13]=0;var n=new BerReader(t);e.equal(n.readSequence(),48,"Not an ASN.1 Sequence");e.equal(n.length,12,"Message length should be 12");e.equal(n.readInt(),4,"Message id should have been 4");e.equal(n.readSequence(),96,"Bind Request should have been 96");e.equal(n.length,7,"Bind length should have been 7");e.equal(n.readInt(),3,"LDAP version should have been 3");e.equal(n.readString(),"","Bind DN should have been empty");e.equal(n.length,0,"string length should have been 0");e.equal(n.readByte(),128,"Should have been ContextSpecific (choice)");e.equal(n.readByte(),0,"Should have been simple bind");e.equal(null,n.readByte(),"Should be out of data");e.end()});test("long string",function(e){var t=new Buffer(256),n,r="2;649;CN=Red Hat CS 71GA Demo,O=Red Hat CS 71GA Demo,C=US;CN=RHCS Agent - admin01,UID=admin01,O=redhat,C=US [1] This is Teena Vradmin's description.";t[0]=4;t[1]=129;t[2]=148;t.write(r,3);var i=new BerReader(t.slice(0,3+r.length));e.equal(i.readString(),r);e.end()});