function FormData(){this._overheadLength=0;this._valueLength=0;this._lengthRetrievers=[];CombinedStream.call(this)}function populate(e,t){for(var n in t)e[n]||(e[n]=t[n]);return e}var CombinedStream=require("combined-stream"),util=require("util"),path=require("path"),http=require("http"),https=require("https"),parseUrl=require("url").parse,fs=require("fs"),mime=require("mime"),async=require("async");module.exports=FormData;util.inherits(FormData,CombinedStream);FormData.LINE_BREAK="\r\n";FormData.prototype.append=function(e,t,n){n=n||{};var r=CombinedStream.prototype.append.bind(this);typeof t=="number"&&(t=""+t);if(util.isArray(t)){this._error(new Error("Arrays are not supported."));return}var i=this._multiPartHeader(e,t,n),s=this._multiPartFooter(e,t,n);r(i);r(t);r(s);this._trackLength(i,t,n)};FormData.prototype._trackLength=function(e,t,n){var r=0;n.knownLength!=null?r+=+n.knownLength:Buffer.isBuffer(t)?r=t.length:typeof t=="string"&&(r=Buffer.byteLength(t));this._valueLength+=r;this._overheadLength+=Buffer.byteLength(e)+ +FormData.LINE_BREAK.length;if(!t||!t.path&&(!t.readable||!t.hasOwnProperty("httpVersion")))return;n.knownLength||this._lengthRetrievers.push(function(e){if(t.hasOwnProperty("fd"))fs.stat(t.path,function(t,n){if(t){e(t);return}e(null,n.size)});else if(t.hasOwnProperty("httpVersion"))e(null,+t.headers["content-length"]);else if(t.hasOwnProperty("httpModule")){t.on("response",function(n){t.pause();e(null,+n.headers["content-length"])});t.resume()}else e("Unknown stream")})};FormData.prototype._multiPartHeader=function(e,t,n){var r=this.getBoundary(),i="";if(n.header!=null)i=n.header;else{i+="--"+r+FormData.LINE_BREAK+'Content-Disposition: form-data; name="'+e+'"';n.filename||t.path?i+='; filename="'+path.basename(n.filename||t.path)+'"'+FormData.LINE_BREAK+"Content-Type: "+(n.contentType||mime.lookup(n.filename||t.path)):t.readable&&t.hasOwnProperty("httpVersion")&&(i+='; filename="'+path.basename(t.client._httpMessage.path)+'"'+FormData.LINE_BREAK+"Content-Type: "+t.headers["content-type"]);i+=FormData.LINE_BREAK+FormData.LINE_BREAK}return i};FormData.prototype._multiPartFooter=function(e,t,n){return function(e){var t=FormData.LINE_BREAK,n=this._streams.length===0;n&&(t+=this._lastBoundary());e(t)}.bind(this)};FormData.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"};FormData.prototype.getHeaders=function(e){var t={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(var n in e)t[n.toLowerCase()]=e[n];return t};FormData.prototype.getCustomHeaders=function(e){e=e?e:"multipart/form-data";var t={"content-type":e+"; boundary="+this.getBoundary(),"content-length":this.getLengthSync()};return t};FormData.prototype.getBoundary=function(){this._boundary||this._generateBoundary();return this._boundary};FormData.prototype._generateBoundary=function(){var e="--------------------------";for(var t=0;t<24;t++)e+=Math.floor(Math.random()*10).toString(16);this._boundary=e};FormData.prototype.getLengthSync=function(e){var t=this._overheadLength+this._valueLength;this._streams.length&&(t+=this._lastBoundary().length);this._lengthRetrievers.length&&this._error(new Error("Cannot calculate proper length in synchronous way."));return t};FormData.prototype.getLength=function(e){var t=this._overheadLength+this._valueLength;this._streams.length&&(t+=this._lastBoundary().length);if(!this._lengthRetrievers.length){process.nextTick(e.bind(this,null,t));return}async.parallel(this._lengthRetrievers,function(n,r){if(n){e(n);return}r.forEach(function(e){t+=e});e(null,t)})};FormData.prototype.submit=function(e,t){var n,r,i={method:"post",headers:this.getHeaders()};if(typeof e=="string"){e=parseUrl(e);r=populate({port:e.port,path:e.pathname,host:e.hostname},i)}else{r=populate(e,i);r.port||(r.port=r.protocol=="https:"?443:80)}e.protocol=="https:"?n=https.request(r):n=http.request(r);this.getLength(function(e,r){n.setHeader("Content-Length",r);this.pipe(n);if(t){n.on("error",t);n.on("response",t.bind(this,null))}}.bind(this));return n};FormData.prototype._error=function(e){if(this.error)return;this.error=e;this.pause();this.emit("error",e)};