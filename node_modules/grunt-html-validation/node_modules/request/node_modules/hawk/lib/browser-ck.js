/*
    HTTP Hawk Authentication Scheme
    Copyright (c) 2012-2013, Eran Hammer <eran@hueniverse.com>
    MIT Licensed
*/// Declare namespace
var hawk={};typeof module!="undefined"&&module.exports&&(module.exports=hawk);hawk.client={header:function(e,t,n){var r={field:"",artifacts:{}};if(!e||typeof e!="string"&&typeof e!="object"||!t||typeof t!="string"||!n||typeof n!="object")return r;var i=n.timestamp||Math.floor((hawk.utils.now()+(n.localtimeOffsetMsec||0))/1e3),s=n.credentials;if(!s||!s.id||!s.key||!s.algorithm)return r;if(hawk.crypto.algorithms.indexOf(s.algorithm)===-1)return r;typeof e=="string"&&(e=hawk.utils.parseUri(e));var o={ts:i,nonce:n.nonce||hawk.utils.randomString(6),method:t,resource:e.relative,host:e.hostname,port:e.port,hash:n.hash,ext:n.ext,app:n.app,dlg:n.dlg};r.artifacts=o;!o.hash&&n.hasOwnProperty("payload")&&(o.hash=hawk.crypto.calculatePayloadHash(n.payload,s.algorithm,n.contentType));var u=hawk.crypto.calculateMac("header",s,o),a=o.ext!==null&&o.ext!==undefined&&o.ext!=="",f='Hawk id="'+s.id+'", ts="'+o.ts+'", nonce="'+o.nonce+(o.hash?'", hash="'+o.hash:"")+(a?'", ext="'+hawk.utils.escapeHeaderAttribute(o.ext):"")+'", mac="'+u+'"';o.app&&(f+=', app="'+o.app+(o.dlg?'", dlg="'+o.dlg:"")+'"');r.field=f;return r},authenticate:function(e,t,n,r){r=r||{};if(e.getResponseHeader("www-authenticate")){var i=hawk.utils.parseAuthorizationHeader(e.getResponseHeader("www-authenticate"),["ts","tsm","error"]);if(!i)return!1;if(i.ts){var s=hawk.crypto.calculateTsMac(i.ts,t);if(s!==i.tsm)return!1;hawk.utils.setNtpOffset(i.ts-Math.floor(Date.now()/1e3))}}if(!e.getResponseHeader("server-authorization")&&!r.required)return!0;var i=hawk.utils.parseAuthorizationHeader(e.getResponseHeader("server-authorization"),["mac","ext","hash"]);if(!i)return!1;var o={ts:n.ts,nonce:n.nonce,method:n.method,resource:n.resource,host:n.host,port:n.port,hash:i.hash,ext:i.ext,app:n.app,dlg:n.dlg},u=hawk.crypto.calculateMac("response",t,o);if(u!==i.mac)return!1;if(!r.hasOwnProperty("payload"))return!0;if(!i.hash)return!1;var a=hawk.crypto.calculatePayloadHash(r.payload,t.algorithm,e.getResponseHeader("content-type"));return a===i.hash},message:function(e,t,n,r){if(!e||typeof e!="string"||!t||typeof t!="number"||n===null||n===undefined||typeof n!="string"||!r||typeof r!="object")return null;var i=r.timestamp||Math.floor((hawk.utils.now()+(r.localtimeOffsetMsec||0))/1e3),s=r.credentials;if(!s||!s.id||!s.key||!s.algorithm)return null;if(hawk.crypto.algorithms.indexOf(s.algorithm)===-1)return null;var o={ts:i,nonce:r.nonce||hawk.utils.randomString(6),host:e,port:t,hash:hawk.crypto.calculatePayloadHash(n,s.algorithm)},u={id:s.id,ts:o.ts,nonce:o.nonce,hash:o.hash,mac:hawk.crypto.calculateMac("message",s,o)};return u}};hawk.crypto={headerVersion:"1",algorithms:["sha1","sha256"],calculateMac:function(e,t,n){var r=hawk.crypto.generateNormalizedString(e,n),i=CryptoJS["Hmac"+t.algorithm.toUpperCase()](r,t.key);return i.toString(CryptoJS.enc.Base64)},generateNormalizedString:function(e,t){var n="hawk."+hawk.crypto.headerVersion+"."+e+"\n"+t.ts+"\n"+t.nonce+"\n"+(t.method||"").toUpperCase()+"\n"+(t.resource||"")+"\n"+t.host.toLowerCase()+"\n"+t.port+"\n"+(t.hash||"")+"\n";t.ext&&(n+=t.ext.replace("\\","\\\\").replace("\n","\\n"));n+="\n";t.app&&(n+=t.app+"\n"+(t.dlg||"")+"\n");return n},calculatePayloadHash:function(e,t,n){var r=CryptoJS.algo[t.toUpperCase()].create();r.update("hawk."+hawk.crypto.headerVersion+".payload\n");r.update(hawk.utils.parseContentType(n)+"\n");r.update(e||"");r.update("\n");return r.finalize().toString(CryptoJS.enc.Base64)},calculateTsMac:function(e,t){var n=CryptoJS["Hmac"+t.algorithm.toUpperCase()]("hawk."+hawk.crypto.headerVersion+".ts\n"+e+"\n",t.key);return n.toString(CryptoJS.enc.Base64)}};hawk.utils={storage:{_cache:{},setItem:function(e,t){hawk.utils.storage._cache[e]=t},getItem:function(e){return hawk.utils.storage._cache[e]}},setStorage:function(e){var t=hawk.utils.getNtpOffset()||0;hawk.utils.storage=e;hawk.utils.setNtpOffset(t)},setNtpOffset:function(e){hawk.utils.storage.setItem("hawk_ntp_offset",e)},getNtpOffset:function(){return parseInt(hawk.utils.storage.getItem("hawk_ntp_offset")||"0",10)},now:function(){return Date.now()+hawk.utils.getNtpOffset()},escapeHeaderAttribute:function(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},parseContentType:function(e){return e?e.split(";")[0].trim().toLowerCase():""},parseAuthorizationHeader:function(e,t){if(!e)return null;var n=e.match(/^(\w+)(?:\s+(.*))?$/);if(!n)return null;var r=n[1];if(r.toLowerCase()!=="hawk")return null;var i=n[2];if(!i)return null;var s={},o=i.replace(/(\w+)="([^"\\]*)"\s*(?:,\s*|$)/g,function(e,n,r){if(t.indexOf(n)===-1)return;if(r.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~]+$/)===null)return;if(s.hasOwnProperty(n))return;s[n]=r;return""});return o!==""?null:s},randomString:function(e){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",n=t.length,r=[];for(var i=0;i<e;++i)r[i]=t[Math.floor(Math.random()*n)];return r.join("")},parseUri:function(e){var t=["source","protocol","authority","userInfo","user","password","hostname","port","resource","relative","pathname","directory","file","query","fragment"],n=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)(?:#(.*))?)/,r=n.exec(e),i={},s=15;while(s--)i[t[s]]=r[s]||"";if(i.port===null||i.port==="")i.port=i.protocol.toLowerCase()==="http"?"80":i.protocol.toLowerCase()==="https"?"443":"";return i}};var CryptoJS=CryptoJS||function(e,t){var n={},r=n.lib={},i=function(){},s=r.Base={extend:function(e){i.prototype=this;var t=new i;e&&t.mixIn(e);t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)});t.init.prototype=t;t.$super=this;return t},create:function(){var e=this.extend();e.init.apply(e,arguments);return e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=s.extend({init:function(e,n){e=this.words=e||[];this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;e=e.sigBytes;this.clamp();if(r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);this.sigBytes+=e;return this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4);t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);e.words=this.words.slice(0);return e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new o.init(n,t)}}),u=n.enc={},a=u.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-8*(r%4)&255;n.push((i>>>4).toString(16));n.push((i&15).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-4*(r%8);return new o.init(n,t/2)}},f=u.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-8*(r%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(e.charCodeAt(r)&255)<<24-8*(r%4);return new o.init(n,t)}},l=u.Utf8={stringify:function(e){try{return decodeURIComponent(escape(f.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return f.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init;this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e));this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,s=this.blockSize,u=i/(4*s),u=t?e.ceil(u):e.max((u|0)-this._minBufferSize,0);t=u*s;i=e.min(4*t,i);if(t){for(var a=0;a<t;a+=s)this._doProcessBlock(r,a);a=r.splice(0,t);n.sigBytes-=i}return new o.init(a,i)},clone:function(){var e=s.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});r.Hasher=c.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){c.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return(new e.init(n)).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return(new h.HMAC.init(e,n)).finalize(t)}}});var h=n.algo={};return n}(Math);(function(){var e=CryptoJS,t=e.lib,n=t.WordArray,r=t.Hasher,i=[],t=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=0;80>f;f++){if(16>f)i[f]=e[t+f]|0;else{var l=i[f-3]^i[f-8]^i[f-14]^i[f-16];i[f]=l<<1|l>>>31}l=(r<<5|r>>>27)+a+i[f];l=20>f?l+((s&o|~s&u)+1518500249):40>f?l+((s^o^u)+1859775393):60>f?l+((s&o|s&u|o&u)-1894007588):l+((s^o^u)-899497514);a=u;u=o;o=s<<30|s>>>2;s=r;r=l}n[0]=n[0]+r|0;n[1]=n[1]+s|0;n[2]=n[2]+o|0;n[3]=n[3]+u|0;n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32;t[(r+64>>>9<<4)+14]=Math.floor(n/4294967296);t[(r+64>>>9<<4)+15]=n;e.sigBytes=4*t.length;this._process();return this._hash},clone:function(){var e=r.clone.call(this);e._hash=this._hash.clone();return e}});e.SHA1=r._createHelper(t);e.HmacSHA1=r._createHmacHelper(t)})();(function(e){for(var t=CryptoJS,n=t.lib,r=n.WordArray,i=n.Hasher,n=t.algo,s=[],o=[],u=function(e){return 4294967296*(e-(e|0))|0},a=2,f=0;64>f;){var l;e:{l=a;for(var c=e.sqrt(l),h=2;h<=c;h++)if(!(l%h)){l=!1;break e}l=!0}l&&(8>f&&(s[f]=u(e.pow(a,.5))),o[f]=u(e.pow(a,1/3)),f++);a++}var p=[],n=n.SHA256=i.extend({_doReset:function(){this._hash=new r.init(s.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=0;64>h;h++){if(16>h)p[h]=e[t+h]|0;else{var d=p[h-15],v=p[h-2];p[h]=((d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3)+p[h-7]+((v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10)+p[h-16]}d=c+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&f^~a&l)+o[h]+p[h];v=((r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22))+(r&i^r&s^i&s);c=l;l=f;f=a;a=u+d|0;u=s;s=i;i=r;r=d+v|0}n[0]=n[0]+r|0;n[1]=n[1]+i|0;n[2]=n[2]+s|0;n[3]=n[3]+u|0;n[4]=n[4]+a|0;n[5]=n[5]+f|0;n[6]=n[6]+l|0;n[7]=n[7]+c|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;n[(i+64>>>9<<4)+14]=e.floor(r/4294967296);n[(i+64>>>9<<4)+15]=r;t.sigBytes=4*n.length;this._process();return this._hash},clone:function(){var e=i.clone.call(this);e._hash=this._hash.clone();return e}});t.SHA256=i._createHelper(n);t.HmacSHA256=i._createHmacHelper(n)})(Math);(function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=new e.init;"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n));n.clamp();for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),u=s.words,a=o.words,f=0;f<r;f++)u[f]^=1549556828,a[f]^=909522486;s.sigBytes=o.sigBytes=i;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var t=this._hasher;e=t.finalize(e);t.reset();return t.finalize(this._oKey.clone().concat(e))}})})();(function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();e=[];for(var i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-8*(i%4)&255)<<16|(t[i+1>>>2]>>>24-8*((i+1)%4)&255)<<8|t[i+2>>>2]>>>24-8*((i+2)%4)&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var n=e.length,r=this._map,i=r.charAt(64);i&&(i=e.indexOf(i),-1!=i&&(n=i));for(var i=[],s=0,o=0;o<n;o++)if(o%4){var u=r.indexOf(e.charAt(o-1))<<2*(o%4),a=r.indexOf(e.charAt(o))>>>6-2*(o%4);i[s>>>2]|=(u|a)<<24-8*(s%4);s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();