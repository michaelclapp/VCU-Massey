// Load modules
var Boom=require("boom"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.authenticate=function(e,t,n,r){r=Utils.nextTick(r);n.nonceFunc=n.nonceFunc||function(e,t,n){return n()};n.timestampSkewSec=n.timestampSkewSec||60;var i=Utils.now()+(n.localtimeOffsetMsec||0),s=Utils.parseRequest(e,n);if(s instanceof Error)return r(Boom.badRequest(s.message));var o=Utils.parseAuthorizationHeader(s.authorization);if(o instanceof Error)return r(o);var u={method:s.method,host:s.host,port:s.port,resource:s.url,ts:o.ts,nonce:o.nonce,hash:o.hash,ext:o.ext,app:o.app,dlg:o.dlg,mac:o.mac,id:o.id};if(!o.id||!o.ts||!o.nonce||!o.mac)return r(Boom.badRequest("Missing attributes"),null,u);t(o.id,function(e,t){if(e)return r(e,t||null,u);if(!t)return r(Boom.unauthorized("Unknown credentials","Hawk"),null,u);if(!t.key||!t.algorithm)return r(Boom.internal("Invalid credentials"),t,u);if(Crypto.algorithms.indexOf(t.algorithm)===-1)return r(Boom.internal("Unknown algorithm"),t,u);var a=Crypto.calculateMac("header",t,u);if(!Cryptiles.fixedTimeComparison(a,o.mac))return r(Boom.unauthorized("Bad mac","Hawk"),t,u);if(n.payload!==null&&n.payload!==undefined){if(!o.hash)return r(Boom.unauthorized("Missing required payload hash","Hawk"),t,u);var f=Crypto.calculatePayloadHash(n.payload,t.algorithm,s.contentType);if(!Cryptiles.fixedTimeComparison(f,o.hash))return r(Boom.unauthorized("Bad payload hash","Hawk"),t,u)}n.nonceFunc(o.nonce,o.ts,function(e){if(e)return r(Boom.unauthorized("Invalid nonce","Hawk"),t,u);if(Math.abs(o.ts*1e3-i)>n.timestampSkewSec*1e3){var s=Math.floor((Utils.now()+(n.localtimeOffsetMsec||0))/1e3),a=Crypto.calculateTsMac(s,t);return r(Boom.unauthorized("Stale timestamp","Hawk",{ts:s,tsm:a}),t,u)}return r(null,t,u)})})};exports.authenticatePayload=function(e,t,n,r){var i=Crypto.calculatePayloadHash(e,t.algorithm,r);return Cryptiles.fixedTimeComparison(i,n.hash)};exports.header=function(e,t,n){n=n||{};if(!t||typeof t!="object"||typeof n!="object")return"";t=Hoek.clone(t);delete t.mac;t.hash=n.hash;t.ext=n.ext;if(!e||!e.key||!e.algorithm)return"";if(Crypto.algorithms.indexOf(e.algorithm)===-1)return"";!t.hash&&n.hasOwnProperty("payload")&&(t.hash=Crypto.calculatePayloadHash(n.payload,e.algorithm,n.contentType));var r=Crypto.calculateMac("response",e,t),i='Hawk mac="'+r+'"'+(t.hash?', hash="'+t.hash+'"':"");t.ext!==null&&t.ext!==undefined&&t.ext!==""&&(i+=', ext="'+Utils.escapeHeaderAttribute(t.ext)+'"');return i};exports.authenticateBewit=function(e,t,n,r){r=Utils.nextTick(r);var i=Utils.now()+(n.localtimeOffsetMsec||0),s=Utils.parseRequest(e,n);if(s instanceof Error)return r(Boom.badRequest(s.message));var o=s.url.match(/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/);if(!o)return r(Boom.unauthorized(null,"Hawk"));if(!o[3])return r(Boom.unauthorized("Empty bewit","Hawk"));if(s.method!=="GET"&&s.method!=="HEAD")return r(Boom.unauthorized("Invalid method","Hawk"));if(s.authorization)return r(Boom.badRequest("Multiple authentications","Hawk"));var u=Utils.base64urlDecode(o[3]);if(u instanceof Error)return r(Boom.badRequest("Invalid bewit encoding"));var a=u.split("\\");if(!a||a.length!==4)return r(Boom.badRequest("Invalid bewit structure"));var f={id:a[0],exp:parseInt(a[1],10),mac:a[2],ext:a[3]||""};if(!f.id||!f.exp||!f.mac)return r(Boom.badRequest("Missing bewit attributes"));var l=o[1];o[4]&&(l+=o[2]+o[4]);if(f.exp*1e3<=i)return r(Boom.unauthorized("Access expired","Hawk"),null,f);t(f.id,function(e,t){if(e)return r(e,t||null,f.ext);if(!t)return r(Boom.unauthorized("Unknown credentials","Hawk"),null,f);if(!t.key||!t.algorithm)return r(Boom.internal("Invalid credentials"),t,f);if(Crypto.algorithms.indexOf(t.algorithm)===-1)return r(Boom.internal("Unknown algorithm"),t,f);var n=Crypto.calculateMac("bewit",t,{ts:f.exp,nonce:"",method:"GET",resource:l,host:s.host,port:s.port,ext:f.ext});return Cryptiles.fixedTimeComparison(n,f.mac)?r(null,t,f):r(Boom.unauthorized("Bad mac","Hawk"),t,f)})};exports.authenticateMessage=function(e,t,n,r,i,s,o){o=Utils.nextTick(o);s.nonceFunc=s.nonceFunc||function(e,t,n){return n()};s.timestampSkewSec=s.timestampSkewSec||60;var u=Utils.now()+(s.localtimeOffsetMsec||0);if(!r.id||!r.ts||!r.nonce||!r.hash||!r.mac)return o(Boom.badRequest("Invalid authorization"));i(r.id,function(i,a){if(i)return o(i,a||null);if(!a)return o(Boom.unauthorized("Unknown credentials","Hawk"));if(!a.key||!a.algorithm)return o(Boom.internal("Invalid credentials"),a);if(Crypto.algorithms.indexOf(a.algorithm)===-1)return o(Boom.internal("Unknown algorithm"),a);var f={ts:r.ts,nonce:r.nonce,host:e,port:t,hash:r.hash},l=Crypto.calculateMac("message",a,f);if(!Cryptiles.fixedTimeComparison(l,r.mac))return o(Boom.unauthorized("Bad mac","Hawk"),a);var c=Crypto.calculatePayloadHash(n,a.algorithm);if(!Cryptiles.fixedTimeComparison(c,r.hash))return o(Boom.unauthorized("Bad message hash","Hawk"),a);s.nonceFunc(r.nonce,r.ts,function(e){return e?o(Boom.unauthorized("Invalid nonce","Hawk"),a):Math.abs(r.ts*1e3-u)>s.timestampSkewSec*1e3?o(Boom.unauthorized("Stale timestamp"),a):o(null,a)})})};