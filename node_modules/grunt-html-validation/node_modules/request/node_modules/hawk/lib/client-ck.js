// Load modules
var Url=require("url"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.header=function(e,t,n){var r={field:"",artifacts:{}};if(!e||typeof e!="string"&&typeof e!="object"||!t||typeof t!="string"||!n||typeof n!="object")return r;var i=n.timestamp||Math.floor((Utils.now()+(n.localtimeOffsetMsec||0))/1e3),s=n.credentials;if(!s||!s.id||!s.key||!s.algorithm)return r;if(Crypto.algorithms.indexOf(s.algorithm)===-1)return r;typeof e=="string"&&(e=Url.parse(e));var o={ts:i,nonce:n.nonce||Cryptiles.randomString(6),method:t,resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||(e.protocol==="http:"?80:443),hash:n.hash,ext:n.ext,app:n.app,dlg:n.dlg};r.artifacts=o;!o.hash&&n.hasOwnProperty("payload")&&(o.hash=Crypto.calculatePayloadHash(n.payload,s.algorithm,n.contentType));var u=Crypto.calculateMac("header",s,o),a=o.ext!==null&&o.ext!==undefined&&o.ext!=="",f='Hawk id="'+s.id+'", ts="'+o.ts+'", nonce="'+o.nonce+(o.hash?'", hash="'+o.hash:"")+(a?'", ext="'+Utils.escapeHeaderAttribute(o.ext):"")+'", mac="'+u+'"';o.app&&(f+=', app="'+o.app+(o.dlg?'", dlg="'+o.dlg:"")+'"');r.field=f;return r};exports.authenticate=function(e,t,n,r){n=Hoek.clone(n);r=r||{};if(e.headers["www-authenticate"]){var i=Utils.parseAuthorizationHeader(e.headers["www-authenticate"],["ts","tsm","error"]);if(i instanceof Error)return!1;if(i.ts){var s=Crypto.calculateTsMac(i.ts,t);if(s!==i.tsm)return!1}}if(!e.headers["server-authorization"]&&!r.required)return!0;var i=Utils.parseAuthorizationHeader(e.headers["server-authorization"],["mac","ext","hash"]);if(i instanceof Error)return!1;n.ext=i.ext;n.hash=i.hash;var o=Crypto.calculateMac("response",t,n);if(o!==i.mac)return!1;if(!r.hasOwnProperty("payload"))return!0;if(!i.hash)return!1;var u=Crypto.calculatePayloadHash(r.payload,t.algorithm,e.headers["content-type"]);return u===i.hash};exports.getBewit=function(e,t){if(!e||typeof e!="string"&&typeof e!="object"||!t||typeof t!="object"||!t.ttlSec)return"";t.ext=t.ext===null||t.ext===undefined?"":t.ext;var n=Utils.now()+(t.localtimeOffsetMsec||0),r=t.credentials;if(!r||!r.id||!r.key||!r.algorithm)return"";if(Crypto.algorithms.indexOf(r.algorithm)===-1)return"";typeof e=="string"&&(e=Url.parse(e));var i=Math.floor(n/1e3)+t.ttlSec,s=Crypto.calculateMac("bewit",r,{ts:i,nonce:"",method:"GET",resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||(e.protocol==="http:"?80:443),ext:t.ext}),o=r.id+"\\"+i+"\\"+s+"\\"+t.ext;return Utils.base64urlEncode(o)};exports.message=function(e,t,n,r){if(!e||typeof e!="string"||!t||typeof t!="number"||n===null||n===undefined||typeof n!="string"||!r||typeof r!="object")return null;var i=r.timestamp||Math.floor((Utils.now()+(r.localtimeOffsetMsec||0))/1e3),s=r.credentials;if(!s||!s.id||!s.key||!s.algorithm)return null;if(Crypto.algorithms.indexOf(s.algorithm)===-1)return null;var o={ts:i,nonce:r.nonce||Cryptiles.randomString(6),host:e,port:t,hash:Crypto.calculatePayloadHash(n,s.algorithm)},u={id:s.id,ts:o.ts,nonce:o.nonce,hash:o.hash,mac:Crypto.calculateMac("message",s,o)};return u};