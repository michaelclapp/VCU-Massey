// Load modules
var Fs=require("fs"),Escape=require("./escape"),internals={};exports.clone=function(e,t){if(typeof e!="object"||e===null)return e;t=t||{orig:[],copy:[]};var n=t.orig.indexOf(e);if(n!==-1)return t.copy[n];var r=e instanceof Array?[]:{};t.orig.push(e);t.copy.push(r);for(var i in e)if(e.hasOwnProperty(i))if(e[i]instanceof Buffer)r[i]=new Buffer(e[i]);else if(e[i]instanceof Date)r[i]=new Date(e[i].getTime());else if(e[i]instanceof RegExp){var s=""+(e[i].global?"g":"")+(e[i].ignoreCase?"i":"")+(e[i].multiline?"m":"");r[i]=new RegExp(e[i].source,s)}else r[i]=exports.clone(e[i],t);return r};exports.merge=function(e,t,n,r){exports.assert(e&&typeof e=="object","Invalid target value: must be an object");exports.assert(t===null||t===undefined||typeof t=="object","Invalid source value: must be null, undefined, or an object");if(!t)return e;if(t instanceof Array){exports.assert(e instanceof Array,"Cannot merge array onto an object");r===!1&&(e.length=0);for(var i=0,s=t.length;i<s;++i)e.push(t[i]);return e}var o=Object.keys(t);for(var u=0,a=o.length;u<a;++u){var f=o[u],l=t[f];l&&typeof l=="object"?!e[f]||typeof e[f]!="object"?e[f]=exports.clone(l):exports.merge(e[f],t[f],n,r):l!==null&&l!==undefined?e[f]=l:n!==!1&&(e[f]=l)}return e};exports.applyToDefaults=function(e,t){exports.assert(e&&typeof e=="object","Invalid defaults value: must be an object");exports.assert(!t||t===!0||typeof t=="object","Invalid options value: must be true, falsy or an object");if(!t)return null;var n=exports.clone(e);return t===!0?n:exports.merge(n,t,!1,!1)};exports.unique=function(e,t){var n={},r=[];for(var i=0,s=e.length;i<s;++i){var o=t?e[i][t]:e[i];if(n[o]!==!0){r.push(e[i]);n[o]=!0}}return r};exports.mapToObject=function(e,t){if(!e)return null;var n={};for(var r=0,i=e.length;r<i;++r)t?e[r][t]&&(n[e[r][t]]=!0):n[e[r]]=!0;return n};exports.intersect=function(e,t,n){if(!e||!t)return[];var r=[],i=e instanceof Array?exports.mapToObject(e):e,s={};for(var o=0,u=t.length;o<u;++o)if(i[t[o]]&&!s[t[o]]){if(n)return t[o];r.push(t[o]);s[t[o]]=!0}return n?null:r};exports.matchKeys=function(e,t){var n=[];for(var r=0,i=t.length;r<i;++r)e.hasOwnProperty(t[r])&&n.push(t[r]);return n};exports.flatten=function(e,t){var n=t||[];for(var r=0,i=e.length;r<i;++r)Array.isArray(e[r])?exports.flatten(e[r],n):n.push(e[r]);return n};exports.removeKeys=function(e,t){for(var n=0,r=t.length;n<r;n++)delete e[t[n]]};exports.reach=function(e,t){var n=t.split("."),r=e;for(var i=0,s=n.length;i<s;++i)r&&(r=r[n[i]]);return r};exports.inheritAsync=function(e,t,n){n=n||null;for(var r in t)if(t.hasOwnProperty(r)){if(n instanceof Array&&n.indexOf(r)<0)continue;e.prototype[r]=function(e){return function(t){var n=null;try{n=e()}catch(r){return t(r)}return t(null,n)}}(t[r])}};exports.formatStack=function(e){var t=[];for(var n=0,r=e.length;n<r;++n){var i=e[n];t.push([i.getFileName(),i.getLineNumber(),i.getColumnNumber(),i.getFunctionName(),i.isConstructor()])}return t};exports.formatTrace=function(e){var t=[];for(var n=0,r=e.length;n<r;++n){var i=e[n];t.push((i[4]?"new ":"")+i[3]+" ("+i[0]+":"+i[1]+":"+i[2]+")")}return t};exports.callStack=function(e){var t=Error.prepareStackTrace;Error.prepareStackTrace=function(e,t){return t};var n={};Error.captureStackTrace(n,arguments.callee);var r=n.stack;Error.prepareStackTrace=t;var i=exports.formatStack(r);return e?i.slice(e):i};exports.displayStack=function(e){var t=exports.callStack(e===undefined?1:e+1);return exports.formatTrace(t)};exports.abortThrow=!1;exports.abort=function(e,t){if(process.env.NODE_ENV==="test"||exports.abortThrow===!0)throw new Error(e||"Unknown error");var n="";t||(n=exports.displayStack(1).join("\n	"));console.log("ABORT: "+e+"\n	"+n);process.exit(1)};exports.assert=function(e){if(e)return;var t=Array.prototype.slice.call(arguments,1);t=t.map(function(e){return typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)});throw new Error(t.join(" ")||"Unknown error")};exports.loadDirModules=function(e,t,n){var r={};for(var i=0,s=t.length;i<s;++i)r[t[i]+".js"]=!0;var o=Fs.readdirSync(e);for(i=0,s=o.length;i<s;++i){var u=o[i];if(/\.js$/.test(u)&&!r[u]){var a=u.substr(0,u.lastIndexOf(".")),f=a.charAt(0).toUpperCase()+a.substr(1).toLowerCase();typeof n!="function"?n[f]=require(e+"/"+a):n(e+"/"+a,a,f)}}};exports.rename=function(e,t,n){e[n]=e[t];delete e[t]};exports.Timer=function(){this.reset()};exports.Timer.prototype.reset=function(){this.ts=Date.now()};exports.Timer.prototype.elapsed=function(){return Date.now()-this.ts};exports.loadPackage=function(e){var t={},n=(e||process.env.PWD)+"/package.json";if(Fs.existsSync(n))try{t=JSON.parse(Fs.readFileSync(n))}catch(r){}return t};exports.escapeRegex=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")};exports.toss=function(e){var t=arguments.length===3?arguments[1]:"",n=arguments.length===3?arguments[2]:arguments[1],r=t instanceof Error?t:t?new Error(t):e instanceof Error?e:new Error;if(e instanceof Error||!e)return n(r)};exports.base64urlEncode=function(e){return(new Buffer(e,"binary")).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")};exports.base64urlDecode=function(e){if(e&&!e.match(/^[\w\-]*$/))return new Error("Invalid character");try{return(new Buffer(e.replace(/-/g,"+").replace(/:/g,"/"),"base64")).toString("binary")}catch(t){return t}};exports.escapeHeaderAttribute=function(e){exports.assert(e.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~\"\\]*$/),"Bad attribute value ("+e+")");return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')};exports.escapeHtml=function(e){return Escape.escapeHtml(e)};exports.escapeJavaScript=function(e){return Escape.escapeJavaScript(e)};exports.consoleFunc=console.log;exports.printEvent=function(e){var t=function(e){return(e<10?"0":"")+e},n=new Date(e.timestamp),r=(n.getYear()-100).toString()+t(n.getMonth()+1)+t(n.getDate())+"/"+t(n.getHours())+t(n.getMinutes())+t(n.getSeconds())+"."+n.getMilliseconds(),i=e.data;if(typeof e.data!="string")try{i=JSON.stringify(e.data)}catch(s){i="JSON Error: "+s.message}var o=r+", "+e.tags[0]+", "+i;exports.consoleFunc(o)};exports.nextTick=function(e){return function(){var t=arguments;process.nextTick(function(){e.apply(null,t)})}};