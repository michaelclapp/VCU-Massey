// Load modules
var Url=require("url"),Lab=require("lab"),Hoek=require("hoek"),Hawk=require("../lib"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){var e=function(e,t){var n={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:e==="1"?"sha1":"sha256",user:"steve"};return t(null,n)};it("should generate an authorization then successfully parse it",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{},function(e,n){expect(e).to.not.exist;expect(n.user).to.equal("steve");t()})})});it("should fail authorization on mismatching host",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;Hawk.server.authenticateMessage("example1.com",8080,"some message",i,e,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Bad mac");t()})})});it("should fail authorization on stale timestamp",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{localtimeOffsetMsec:1e5},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Stale timestamp");t()})})});it("should fail authorization on invalid authorization",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;delete i.id;Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Invalid authorization");t()})})});it("should fail authorization on bad hash",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;Hawk.server.authenticateMessage("example.com",8080,"some message1",i,e,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Bad message hash");t()})})});it("should fail authorization on nonce error",function(t){e("123456",function(n,r){var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.exist;Hawk.server.authenticateMessage("example.com",8080,"some message",i,e,{nonceFunc:function(e,t,n){n(new Error("kaboom"))}},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Invalid nonce");t()})})});it("should fail authorization on credentials error",function(t){e("123456",function(e,n){var r=Hawk.client.message("example.com",8080,"some message",{credentials:n});expect(r).to.exist;var i=function(e,t){t(new Error("kablooey"))};Hawk.server.authenticateMessage("example.com",8080,"some message",r,i,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("kablooey");t()})})});it("should fail authorization on missing credentials",function(t){e("123456",function(e,n){var r=Hawk.client.message("example.com",8080,"some message",{credentials:n});expect(r).to.exist;var i=function(e,t){t()};Hawk.server.authenticateMessage("example.com",8080,"some message",r,i,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Unknown credentials");t()})})});it("should fail authorization on invalid credentials",function(t){e("123456",function(e,n){var r=Hawk.client.message("example.com",8080,"some message",{credentials:n});expect(r).to.exist;var i=function(e,t){t(null,{})};Hawk.server.authenticateMessage("example.com",8080,"some message",r,i,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Invalid credentials");t()})})});it("should fail authorization on invalid credentials algorithm",function(t){e("123456",function(e,n){var r=Hawk.client.message("example.com",8080,"some message",{credentials:n});expect(r).to.exist;var i=function(e,t){t(null,{key:"123",algorithm:"456"})};Hawk.server.authenticateMessage("example.com",8080,"some message",r,i,{},function(e,n){expect(e).to.exist;expect(e.message).to.equal("Unknown algorithm");t()})})});it("should fail on missing host",function(t){e("123456",function(e,n){var r=Hawk.client.message(null,8080,"some message",{credentials:n});expect(r).to.not.exist;t()})});it("should fail on missing credentials",function(e){var t=Hawk.client.message("example.com",8080,"some message",{});expect(t).to.not.exist;e()});it("should fail on invalid algorithm",function(t){e("123456",function(e,n){var r=Hoek.clone(n);r.algorithm="blah";var i=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(i).to.not.exist;t()})})});