var server=require("./server"),assert=require("assert"),request=require("../index"),Cookie=require("cookie-jar"),Jar=Cookie.Jar,s=server.createServer();s.listen(s.port,function(){function r(n,r){var i=r+"_landing";s.on("/"+r,function(s,o){t[r]=!0;o.writeHead(n,{location:e+"/"+i,"set-cookie":"ham=eggs"});o.end()});s.on("/"+i,function(e,n){if(e.method!=="GET"){console.error("Got a non-GET request to the redirect destination URL");n.writeHead(400);n.end();return}assert.equal(e.headers.cookie,"foo=bar; quux=baz; ham=eggs");t[i]=!0;n.writeHead(200);n.end(i)})}function u(){o+=1;if(o==9){console.log(n+" tests passed.");s.close()}}var e="http://localhost:"+s.port,t={},n=0;r(301,"temp");r(302,"perm");r(302,"nope");var i=new Jar;i.add(new Cookie("quux=baz"));request({uri:e+"/perm",jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);assert.ok(t.perm,"Original request is to /perm");assert.ok(t.perm_landing,"Forward to permanent landing URL");assert.equal(i,"perm_landing","Got permanent landing content");n+=1;u()});request({uri:e+"/temp",jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(t.temp_landing,"Forward to temporary landing URL");assert.equal(i,"temp_landing","Got temporary landing content");n+=1;u()});request({uri:e+"/nope",jar:i,headers:{cookie:"foo=bar"},followRedirect:!1},function(e,r,i){if(e)throw e;if(r.statusCode!==302)throw new Error("Status is not 302: "+r.statusCode);assert.ok(t.nope,"Original request to /nope");assert.ok(!t.nope_landing,"No chasing the redirect");assert.equal(r.statusCode,302,"Response is the bounce itself");n+=1;u()});request.post(e+"/temp",{jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(!t.temp_landing,"No chasing the redirect when post");assert.equal(r.statusCode,301,"Response is the bounce itself");n+=1;u()});request.post({uri:e+"/temp",followAllRedirects:!0,jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(t.temp_landing,"Forward to temporary landing URL");assert.equal(i,"temp_landing","Got temporary landing content");n+=1;u()});request.post({uri:e+"/temp",followAllRedirects:!1,jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(!t.temp_landing,"No chasing the redirect");assert.equal(r.statusCode,301,"Response is the bounce itself");n+=1;u()});request.del(e+"/temp",{jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode<301)throw new Error("Status is not a redirect.");assert.ok(t.temp,"Original request is to /temp");assert.ok(!t.temp_landing,"No chasing the redirect when delete");assert.equal(r.statusCode,301,"Response is the bounce itself");n+=1;u()});request.del(e+"/temp",{followRedirect:!0,jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(!t.temp_landing,"No chasing the redirect when delete");assert.equal(r.statusCode,301,"Response is the bounce itself");n+=1;u()});request.del(e+"/temp",{followAllRedirects:!0,jar:i,headers:{cookie:"foo=bar"}},function(e,r,i){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);assert.ok(t.temp,"Original request is to /temp");assert.ok(t.temp_landing,"Forward to temporary landing URL");assert.equal(i,"temp_landing","Got temporary landing content");n+=1;u()});var o=0});