var _=require("underscore"),utils=require("../utils"),isTag=utils.isTag,decode=utils.decode,encode=utils.encode,hasOwn=Object.prototype.hasOwnProperty,rspace=/\s+/,primitives={"null":null,"true":!0,"false":!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,setAttr=function(e,t,n){if(typeof t=="object")return _.extend(e.attribs,t);n===null?removeAttribute(e,t):e.attribs[t]=encode(n);return e.attribs},attr=exports.attr=function(e,t){if(typeof e=="object"||t!==undefined)return _.isFunction(t)?this.each(function(n,r){setAttr(r,e,t.call(this,n,r.attribs[e]))}):this.each(function(n,r){r.attribs=setAttr(r,e,t)});var n=this[0];if(!n||!isTag(n))return;n.attribs||(n.attribs={});if(!e){for(var r in n.attribs)n.attribs[r]=decode(n.attribs[r]);return n.attribs}if(hasOwn.call(n.attribs,e))return decode(n.attribs[e])},setData=function(e,t,n){if(typeof t=="object")return _.extend(e.data,t);typeof t=="string"&&n!==undefined?e.data[t]=encode(n):typeof t=="object"&&_.each(t,function(t,n){e.data[n]=encode(t)});return e.data},data=exports.data=function(e,t){var n=this[0];if(!n||!isTag(n))return;n.data||(n.data={});if(!e){_.each(n.data,function(e,t){n.data[t]=decode(e)});return n.data}if(typeof e=="object"||t!==undefined){this.each(function(n,r){r.data=setData(r,e,t)});return this}if(hasOwn.call(n.data,e)){var r=decode(n.data[e]);hasOwn.call(primitives,r)?r=primitives[r]:r===String(Number(r))?r=Number(r):rbrace.test(r)&&(r=JSON.parse(r));return r}return typeof e=="string"&&t===undefined?undefined:this},val=exports.val=function(e){var t=arguments.length===0,n=this[0];if(!n)return;switch(n.name){case"textarea":return t?this.text():this.each(function(){this.text(e)});case"input":switch(this.attr("type")){case"radio":var r="input[type=radio][name="+this.attr("name")+"]:checked",i,s;i=this.closest("form");if(i.length===0){s=(this.parents().last()[0]||this[0]).parent;i=this.make(s)}if(t)return i.find(r).attr("value");i.find(":checked").removeAttr("checked");i.find('input[type=radio][value="'+e+'"]').attr("checked","");return this;default:return t?this.attr("value"):this.each(function(){this.attr("value",e)})}return;case"select":var o=this.find("option:selected"),u;if(o===undefined)return undefined;if(!t){if(!this.attr().hasOwnProperty("multiple")&&typeof e=="object")return this;typeof e!="object"&&(e=[e]);this.find("option").removeAttr("selected");for(var a=0;a<e.length;a++)this.find('option[value="'+e[a]+'"]').attr("selected","");return this}u=o.attr("value");if(this.attr().hasOwnProperty("multiple")){u=[];o.each(function(){u.push(this.attr("value"))})}return u;case"option":if(!t){this.attr("value",e);return this}return this.attr("value")}},removeAttribute=function(e,t){if(!isTag(e.type)||!e.attribs||!Object.hasOwnProperty.call(e.attribs,t))return;rboolean.test(e.attribs[t])?e.attribs[t]=!1:delete e.attribs[t]},removeAttr=exports.removeAttr=function(e){this.each(function(t,n){removeAttribute(n,e)});return this},hasClass=exports.hasClass=function(e){return _.any(this,function(t){var n=t.attribs;return n&&_.contains((n["class"]||"").split(rspace),e)})},addClass=exports.addClass=function(e){_.isFunction(e)&&this.each(function(t){var n=this.attr("class")||"";this.addClass(e.call(this[0],t,n))});if(!e||!_.isString(e))return this;var t=e.split(rspace),n=this.length,r,i,s;for(var o=0;o<n;o++){s=this.make(this[o]);if(!isTag(this[o]))continue;if(!s.attr("class"))s.attr("class",t.join(" ").trim());else{i=" "+s.attr("class")+" ";r=t.length;for(var u=0;u<r;u++)~i.indexOf(" "+t[u]+" ")||(i+=t[u]+" ");s.attr("class",i.trim())}}return this},removeClass=exports.removeClass=function(e){var t=function(e){return e?e.trim().split(rspace):[]},n,r;if(_.isFunction(e))return this.each(function(t,n){this.removeClass(e.call(this[0],t,n.attribs["class"]||""))});n=t(e);r=arguments.length===0;return this.each(function(e,i){if(!isTag(i))return;i.attribs.class=r?"":_.difference(t(i.attribs.class),n).join(" ")})},toggleClass=exports.toggleClass=function(e,t){if(_.isFunction(e))return this.each(function(n,r){this.toggleClass(e.call(this,n,r.attribs["class"]||"",t),t)});if(!e||!_.isString(e))return this;var n=e.split(rspace),r=n.length,i=typeof t=="boolean",s=this.length,o,u;for(var a=0;a<s;a++){o=this.make(this[a]);if(!isTag(this[a]))continue;for(var f=0;f<r;f++){u=i?t:!o.hasClass(n[f]);o[u?"addClass":"removeClass"](n[f])}}return this},is=exports.is=function(e){return e?this.filter(e).length>0:!1};