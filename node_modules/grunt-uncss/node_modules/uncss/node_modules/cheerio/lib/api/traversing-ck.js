function traverseParents(e,t,n,r){var i=[];while(i.length<r&&t.type!=="root"){(!n||e.make(t).filter(n).length)&&i.push(t);t=t.parent}return e.make(i)}var _=require("underscore"),select=require("cheerio-select"),utils=require("../utils"),isTag=utils.isTag,find=exports.find=function(e){return this.make(_.uniq(select(e,[].slice.call(this.children()))))},parent=exports.parent=function(e){var t=[],n;this.each(function(e,n){var r=n.parent;t.indexOf(r)<0&&r.type!=="root"&&t.push(r)});n=this.make(t);arguments.length&&(n=n.filter(e));return n},parents=exports.parents=function(e){return this[0]&&this[0].parent?traverseParents(this,this[0].parent,e,Infinity):this},closest=exports.closest=function(e){var t=[];if(!e)return this.make(t);this.each(function(n,r){var i=traverseParents(this,r,e,1)[0];i&&t.indexOf(i)<0&&t.push(i)}.bind(this));return this.make(t)},next=exports.next=function(){if(!this[0])return this;var e=this[0];while(e=e.next)if(isTag(e))return this.make(e);return this.make([])},nextAll=exports.nextAll=function(e){if(!this[0])return this;var t=[],n=this[0];while(n=n.next)isTag(n)&&t.push(n);return this.make(e?select(e,t):t)},prev=exports.prev=function(){if(!this[0])return this;var e=this[0];while(e=e.prev)if(isTag(e))return this.make(e);return this.make([])},prevAll=exports.prevAll=function(e){if(!this[0])return this;var t=[],n=this[0];while(n=n.prev)isTag(n)&&t.push(n);return this.make(e?select(e,t):t)},siblings=exports.siblings=function(e){var t=_.filter(this.parent()?this.parent().children():this.siblingsAndMe(),function(e){return isTag(e)&&!this.is(e)},this);e!==undefined&&(t=this.make(select(e,t)));return this.make(t)},children=exports.children=function(e){var t=_.reduce(this,function(e,t){return e.concat(_.filter(t.children,isTag))},[]);return e===undefined?this.make(t):_.isNumber(e)?this.make(t[e]):this.make(t).filter(e)},contents=exports.contents=function(){return this.make(_.reduce(this,function(e,t){e.push.apply(e,t.children);return e},[]))},each=exports.each=function(e){var t=0,n=this.length;while(t<n&&e.call(this.make(this[t]),t,this[t])!==!1)++t;return this},map=exports.map=function(e){return _.map(this,function(t,n){return e.call(this.make(t),n,t)},this)},filter=exports.filter=function(e){var t=_.bind(this.make,this),n;_.isString(e)?n=function(t){return select(e,t)[0]===t}:_.isFunction(e)?n=function(n,r){return e.call(t(n),r,n)}:e.cheerio?n=e.is.bind(e):n=function(t){return e===t};return t(_.filter(this,n))},first=exports.first=function(){return this[0]?this.make(this[0]):this},last=exports.last=function(){return this[0]?this.make(this[this.length-1]):this},eq=exports.eq=function(e){e=+e;e<0&&(e=this.length+e);return this[e]?this.make(this[e]):this.make([])},slice=exports.slice=function(){return this.make([].slice.apply(this,arguments))};