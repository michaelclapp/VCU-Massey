var _=require("underscore"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,encode=require("../utils").encode,slice=Array.prototype.slice,makeDomArray=function(e){return e==null?[]:e.cheerio?e.toArray():_.isArray(e)?_.flatten(e.map(makeDomArray)):_.isString(e)?evaluate(e):[e]},_insert=function(e){return function(){var t=slice.call(arguments),n=makeDomArray(t);return this.each(function(r,i){_.isFunction(t[0])&&(n=makeDomArray(t[0].call(i,r,this.html())));updateDOM(e(n,i.children||(i.children=[])),i)})}},append=exports.append=_insert(function(e,t){return t.concat(e)}),prepend=exports.prepend=_insert(function(e,t){return e.concat(t)}),after=exports.after=function(){var e=slice.call(arguments),t=makeDomArray(e);this.each(function(n,r){var i=r.parent.children,s=i.indexOf(r);if(!~s)return;_.isFunction(e[0])&&(t=makeDomArray(e[0].call(r,n)));i.splice.apply(i,[++s,0].concat(t));updateDOM(i,r.parent);r.parent.children=i});return this},before=exports.before=function(){var e=slice.call(arguments),t=makeDomArray(e);this.each(function(n,r){var i=r.parent.children,s=i.indexOf(r);if(!~s)return;_.isFunction(e[0])&&(t=makeDomArray(e[0].call(r,n)));i.splice.apply(i,[s,0].concat(t));updateDOM(i,r.parent);r.parent.children=i});return this},remove=exports.remove=function(e){var t=this;e&&(t=t.filter(e));t.each(function(e,t){var n=t.parent.children,r=n.indexOf(t);if(!~r)return;n.splice(r,1);updateDOM(n,t.parent);t.parent.children=n});return this},replaceWith=exports.replaceWith=function(e){var t=makeDomArray(e);this.each(function(n,r){var i=r.parent.children,s=i.indexOf(r);if(!~s)return;_.isFunction(e)&&(t=makeDomArray(e.call(r,n)));i.splice.apply(i,[s,1].concat(t));updateDOM(i,r.parent);r.parent.children=i});return this},empty=exports.empty=function(){this.each(function(e,t){t.children=[]});return this},html=exports.html=function(e){if(e===undefined)return!this[0]||!this[0].children?null:$.html(this[0].children);e=e.cheerio?e.toArray():evaluate(e);this.each(function(t,n){n.children=e;updateDOM(n.children,n)});return this},toString=exports.toString=function(){return $.html(this)},text=exports.text=function(e){if(e===undefined)return $.text(this);if(_.isFunction(e))return this.each(function(t,n){return this.text(e.call(n,t,this.text()))});var t={data:encode(e),type:"text",parent:null,prev:null,next:null,children:[]};this.each(function(e,n){n.children=t;updateDOM(n.children,n)});return this},clone=exports.clone=function(){return this.constructor($.html(this))};