/*
	pseudo selectors
	
	---
	
	they are available in two forms:
	* filters called when the selector 
	  is compiled and return a function
	  that needs to return next()
	* pseudos get called on execution
	  they need to return a boolean
*/function getFirstElement(e){for(var t=0;e&&t<e.length;t++)if(isTag(e[t]))return e[t]}function getAttribFunc(e,t){var n={name:e,value:t};return function(t){return checkAttrib(t,n)}}function verifyArgs(e,t,n){if(n===null){if(e.length>1)throw new SyntaxError("pseudo-selector :"+t+" requires an argument")}else if(e.length===1)throw new SyntaxError("pseudo-selector :"+t+" doesn't have any arguments")}var DomUtils=require("domutils"),isTag=DomUtils.isTag,getText=DomUtils.getText,getParent=DomUtils.getParent,getChildren=DomUtils.getChildren,getSiblings=DomUtils.getSiblings,hasAttrib=DomUtils.hasAttrib,getName=DomUtils.getName,getAttribute=DomUtils.getAttributeValue,getNCheck=require("./nth-check.js"),checkAttrib=require("./attributes.js").rules.equals,BaseFuncs=require("./basefunctions.js"),rootFunc=BaseFuncs.rootFunc,trueFunc=BaseFuncs.trueFunc,falseFunc=BaseFuncs.falseFunc,filters={contains:function(e,t){(t.charAt(0)==='"'||t.charAt(0)==="'")&&t.charAt(0)===t.substr(-1)&&(t=t.slice(1,-1));return function(r){return getText(r).indexOf(t)>=0&&e(r)}},"first-child":function(e){return function(n){return getFirstElement(getSiblings(n))===n&&e(n)}},"last-child":function(e){return function(n){var r=getSiblings(n);for(var i=r.length-1;i>=0;i--){if(r[i]===n)return e(n);if(isTag(r[i]))break}return!1}},"first-of-type":function(e){return function(n){var r=getSiblings(n);for(var i=0;i<r.length;i++)if(isTag(r[i])){if(r[i]===n)return e(n);if(getName(r[i])===getName(n))break}return!1}},"last-of-type":function(e){return function(n){var r=getSiblings(n);for(var i=r.length-1;i>=0;i--)if(isTag(r[i])){if(r[i]===n)return e(n);if(getName(r[i])===getName(n))break}return!1}},"only-of-type":function(e){return function(n){var r=getSiblings(n);for(var i=0,s=r.length;i<s;i++)if(isTag(r[i])){if(r[i]===n)continue;if(getName(r[i])===getName(n))return!1}return e(n)}},"only-child":function(e){return function(n){var r=getSiblings(n);for(var i=0;i<r.length;i++)if(isTag(r[i])&&r[i]!==n)return!1;return e(n)}},"nth-child":function(e,t){var n=getNCheck(t);return n===falseFunc?n:n===trueFunc?e===rootFunc?n:e:function(r){var i=getSiblings(r);for(var s=0,o=0;s<i.length;s++)if(isTag(i[s])){if(i[s]===r)break;o++}return n(o)&&e(r)}},"nth-last-child":function(e,t){var n=getNCheck(t);return n===falseFunc?n:n===trueFunc?e===rootFunc?n:e:function(r){var i=getSiblings(r);for(var s=0,o=i.length-1;o>=0;o--)if(isTag(i[o])){if(i[o]===r)break;s++}return n(s)&&e(r)}},"nth-of-type":function(e,t){var n=getNCheck(t);return n===falseFunc?n:n===trueFunc?e===rootFunc?n:e:function(r){var i=getSiblings(r);for(var s=0,o=0;o<i.length;o++)if(isTag(i[o])){if(i[o]===r)break;getName(i[o])===getName(r)&&s++}return n(s)&&e(r)}},"nth-last-of-type":function(e,t){var n=getNCheck(t);return n===falseFunc?n:n===trueFunc?e===rootFunc?n:e:function(r){var i=getSiblings(r);for(var s=0,o=i.length-1;o>=0;o--){if(i[o]===r)break;getName(i[o])===getName(r)&&s++}return n(s)&&e(r)}},checkbox:getAttribFunc("type","checkbox"),file:getAttribFunc("type","file"),password:getAttribFunc("type","password"),radio:getAttribFunc("type","radio"),reset:getAttribFunc("type","reset"),image:getAttribFunc("type","image"),submit:getAttribFunc("type","submit")},pseudos={root:function(e){return!getParent(e)},empty:function(e){return!getChildren(e).some(function(e){return isTag(e)||e.type==="text"})},selected:function(e){if(hasAttrib(e,"selected"))return!0;if(getName(e)!=="option")return!1;var t=getParent(e);if(!t||getName(t)!=="select")return!1;var n=getChildren(t),r=!1;for(var i=0;i<n.length;i++)if(isTag(n[i]))if(n[i]===e)r=!0;else{if(!r)return!1;if(hasAttrib(n[i],"selected"))return!1}return r},disabled:function(e){return hasAttrib(e,"disabled")},enabled:function(e){return!hasAttrib(e,"disabled")},checked:function(e){return hasAttrib(e,"checked")||pseudos.selected(e)},parent:function(e){return!pseudos.empty(e)},header:function(e){var t=getName(e);return t==="h1"||t==="h2"||t==="h3"||t==="h4"||t==="h5"||t==="h6"},button:function(e){var t=getName(e);return t==="button"||t==="input"&&getAttribute(e,"type")==="button"},input:function(e){var t=getName(e);return t==="input"||t==="textarea"||t==="select"||t==="button"},text:function(e){var t;return getName(e)==="input"&&(!(t=getAttribute(e,"type"))||t.toLowerCase()==="text")}};module.exports={compile:function(e,t){var n=t.name,r=t.data;if(typeof filters[n]=="function"){verifyArgs(filters[n],n,r);return filters[n](e,r)}if(typeof pseudos[n]=="function"){var i=pseudos[n];verifyArgs(i,n,r);return function(n){return i(n,r)&&e(n)}}throw new SyntaxError("unmatched pseudo-class :"+n)},filters:filters,pseudos:pseudos};