/**
 * Module dependencies.
 */function Option(e,t){this.flags=e;this.required=~e.indexOf("<");this.optional=~e.indexOf("[");this.bool=!~e.indexOf("-no-");e=e.split(/[ ,|]+/);e.length>1&&!/^[[<]/.test(e[1])&&(this.short=e.shift());this.long=e.shift();this.description=t||""}function Command(e){this.commands=[];this.options=[];this._execs=[];this._args=[];this._name=e}function camelcase(e){return e.split("-").reduce(function(e,t){return e+t[0].toUpperCase()+t.slice(1)})}function pad(e,t){var n=Math.max(0,t-e.length);return e+Array(n+1).join(" ")}function outputHelpIfNecessary(e,t){t=t||[];for(var n=0;n<t.length;n++)if(t[n]=="--help"||t[n]=="-h"){e.outputHelp();process.exit(0)}}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,fs=require("fs"),exists=fs.existsSync,path=require("path"),dirname=path.dirname,basename=path.basename;exports=module.exports=new Command;exports.Command=Command;exports.Option=Option;Option.prototype.name=function(){return this.long.replace("--","").replace("no-","")};Option.prototype.is=function(e){return e==this.short||e==this.long};Command.prototype.__proto__=EventEmitter.prototype;Command.prototype.command=function(e,t){var n=e.split(/ +/),r=new Command(n.shift());t&&r.description(t);t&&(this.executables=!0);t&&(this._execs[r._name]=!0);this.commands.push(r);r.parseExpectedArgs(n);r.parent=this;return t?this:r};Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")};Command.prototype.parseExpectedArgs=function(e){if(!e.length)return;var t=this;e.forEach(function(e){switch(e[0]){case"<":t._args.push({required:!0,name:e.slice(1,-1)});break;case"[":t._args.push({required:!1,name:e.slice(1,-1)})}});return this};Command.prototype.action=function(e){var t=this;this.parent.on(this._name,function(n,r){r=r||[];var i=t.parseOptions(r);outputHelpIfNecessary(t,i.unknown);i.unknown.length>0&&t.unknownOption(i.unknown[0]);i.args.length&&(n=i.args.concat(n));t._args.forEach(function(e,r){e.required&&null==n[r]&&t.missingArgument(e.name)});t._args.length?n[t._args.length]=t:n.push(t);e.apply(this,n)});return this};Command.prototype.option=function(e,t,n,r){var i=this,s=new Option(e,t),o=s.name(),u=camelcase(o);"function"!=typeof n&&(r=n,n=null);if(0==s.bool||s.optional||s.required){0==s.bool&&(r=!0);undefined!==r&&(i[u]=r)}this.options.push(s);this.on(o,function(e){null!=e&&n&&(e=n(e));"boolean"==typeof i[u]||"undefined"==typeof i[u]?null==e?i[u]=s.bool?r||!0:!1:i[u]=e:null!==e&&(i[u]=e)});return this};Command.prototype.parse=function(e){this.executables&&this.addImplicitHelpCommand();this.rawArgs=e;this._name=this._name||basename(e[1]);var t=this.parseOptions(this.normalize(e.slice(2))),n=this.args=t.args,r=this.parseArgs(this.args,t.unknown),i=r.args[0];return this._execs[i]?this.executeSubCommand(e,n,t.unknown):r};Command.prototype.executeSubCommand=function(e,t,n){t=t.concat(n);t.length||this.help();"help"==t[0]&&1==t.length&&this.help();if("help"==t[0]){t[0]=t[1];t[1]="--help"}var r=dirname(e[1]),i=basename(e[1])+"-"+t[0],s=path.join(r,i);t=t.slice(1);var o=spawn(s,t,{stdio:"inherit",customFds:[0,1,2]});o.on("error",function(e){e.code=="ENOENT"?console.error("\n  %s(1) does not exist, try --help\n",i):e.code=="EACCES"&&console.error("\n  %s(1) not executable. try chmod or run with root\n",i)});this.runningCommand=o};Command.prototype.normalize=function(e){var t=[],n,r,i;for(var s=0,o=e.length;s<o;++s){n=e[s];s>0&&(r=this.optionFor(e[s-1]));r&&r.required?t.push(n):n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(e){t.push("-"+e)}):/^--/.test(n)&&~(i=n.indexOf("="))?t.push(n.slice(0,i),n.slice(i+1)):t.push(n)}return t};Command.prototype.parseArgs=function(e,t){var n=this.commands,r=n.length,i;if(e.length){i=e[0];this.listeners(i).length?this.emit(e.shift(),e,t):this.emit("*",e)}else{outputHelpIfNecessary(this,t);t.length>0&&this.unknownOption(t[0])}return this};Command.prototype.optionFor=function(e){for(var t=0,n=this.options.length;t<n;++t)if(this.options[t].is(e))return this.options[t]};Command.prototype.parseOptions=function(e){var t=[],n=e.length,r,i,s,o=[];for(var u=0;u<n;++u){s=e[u];if("--"==s){r=!0;continue}if(r){t.push(s);continue}i=this.optionFor(s);if(i){if(i.required){s=e[++u];if(null==s)return this.optionMissingArgument(i);this.emit(i.name(),s)}else if(i.optional){s=e[u+1];null==s||"-"==s[0]&&"-"!=s?s=null:++u;this.emit(i.name(),s)}else this.emit(i.name());continue}if(s.length>1&&"-"==s[0]){o.push(s);e[u+1]&&"-"!=e[u+1][0]&&o.push(e[++u]);continue}t.push(s)}return{args:t,unknown:o}};Command.prototype.missingArgument=function(e){console.error();console.error("  error: missing required argument `%s'",e);console.error();process.exit(1)};Command.prototype.optionMissingArgument=function(e,t){console.error();t?console.error("  error: option `%s' argument missing, got `%s'",e.flags,t):console.error("  error: option `%s' argument missing",e.flags);console.error();process.exit(1)};Command.prototype.unknownOption=function(e){console.error();console.error("  error: unknown option `%s'",e);console.error();process.exit(1)};Command.prototype.version=function(e,t){if(0==arguments.length)return this._version;this._version=e;t=t||"-V, --version";this.option(t,"output the version number");this.on("version",function(){console.log(e);process.exit(0)});return this};Command.prototype.description=function(e){if(0==arguments.length)return this._description;this._description=e;return this};Command.prototype.usage=function(e){var t=this._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}),n="[options"+(this.commands.length?"] [command":"")+"]"+(this._args.length?" "+t:"");if(0==arguments.length)return this._usage||n;this._usage=e;return this};Command.prototype.largestOptionLength=function(){return this.options.reduce(function(e,t){return Math.max(e,t.flags.length)},0)};Command.prototype.optionHelp=function(){var e=this.largestOptionLength();return[pad("-h, --help",e)+"  "+"output usage information"].concat(this.options.map(function(t){return pad(t.flags,e)+"  "+t.description})).join("\n")};Command.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(e){var t=e._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}).join(" ");return pad(e._name+(e.options.length?" [options]":"")+" "+t,22)+(e.description()?" "+e.description():"")}).join("\n").replace(/^/gm,"    "),""].join("\n"):""};Command.prototype.helpInformation=function(){return["","  Usage: "+this._name+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")};Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation());this.emit("--help")};Command.prototype.help=function(){this.outputHelp();process.exit()};