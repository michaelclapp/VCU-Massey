/*
 * grunt-combine-media-queries
 * https://github.com/buildingblocks/grunt-combine-media-queries
 *
 * Copyright (c) 2013 John Cashmore
 * Licensed under the MIT license.
 */"use strict";module.exports=function(e){e.registerMultiTask("cmq","Find duplicate media queries and combines them.",function(){var t=require("css-parse"),n=require("path"),r=!0,i=this.options({log:!1,ext:!1}),s=function(t){i.log&&e.log.writeln(t)},o=function(e){var t="/*"+e.comment+"*/";return t},u=function(e){var t=e.property+": "+e.value+";";return t},a=function(e){var t="";e.type==="declaration"?t+="\n	"+u(e):e.type==="comment"&&(t+=" "+o(e));return t},f=function(e){var t="";t+=e.selectors.join(",\n")+" {";e.declarations.forEach(function(e){t+=a(e)});t+="\n}\n\n";return t},l=function(e){var t="";e.type==="rule"?t+=f(e):e.type==="comment"&&(t+=o(e)+"\n\n");return t},c=function(e){var t="";if(e.type==="keyframe"){t+=e.values.join(",")+" {";e.declarations.forEach(function(e){t+=a(e)});t+="\n}\n\n"}else e.type==="comment"&&(t+=o(e)+"\n\n");return t},h=function(e){var t="";t+="@media "+e.rule+" {\n\n";e.rules.forEach(function(e){t+=l(e)});t+="}\n\n";s("@media "+e.rule);return t},p=function(e){var t="";t+="@"+(typeof e.vendor!="undefined"?e.vendor:"")+"keyframes "+e.name+" {\n\n";e.keyframes.forEach(function(e){t+=c(e)});t+="}\n\n";return t};this.files.forEach(function(o){o.src.forEach(function(u){r=!1;s("\nFile "+u+" found.");var a=o.dest,f=u.replace(/(.*)\//gi,"");a.indexOf(f)===-1&&(a=n.join(o.dest,f));var c=e.file.read(u),d=t(c),v=[],m={};m.base=[];m.media=[];m.media.minWidth=[];m.media.maxWidth=[];m.media.minHeight=[];m.media.maxHeight=[];m.media.print=[];m.media.blank=[];m.keyframes=[];e.file.write(a,d);d.stylesheet.rules.forEach(function(e){if(e.type==="media"){var t=e.media.replace(/[^A-Za-z0-9]/ig,""),n=m.media.filter(function(e){return e.val===t});if(n.length<1){var r={};r.sortVal=parseFloat(e.media.match(/\d+/g));r.rule=e.media;r.val=t;r.rules=[];m.media.push(r)}var i=0,s=!1;m.media.forEach(function(e){e.val===t&&(s=!0);s||i++});e.rules.forEach(function(e){(e.type==="rule"||"comment")&&m.media[i].rules.push(e)})}else e.type==="keyframes"?m.keyframes.push(e):(e.type==="rule"||"comment")&&m.base.push(e)});m.media.forEach(function(e){e.rule.match(/print/)?m.media.print.push(e):e.rule.match(/min-width/)?m.media.minWidth.push(e):e.rule.match(/min-height/)?m.media.minHeight.push(e):e.rule.match(/max-width/)?m.media.maxWidth.push(e):e.rule.match(/max-height/)?m.media.maxHeight.push(e):m.media.blank.push(e)});m.media.minWidth.sort(function(e,t){return e.sortVal-t.sortVal});m.media.minHeight.sort(function(e,t){return e.sortVal-t.sortVal});m.media.maxWidth.sort(function(e,t){return t.sortVal-e.sortVal});m.media.maxHeight.sort(function(e,t){return t.sortVal-e.sortVal});var g=function(e){e.forEach(function(e){v+=l(e)})},y=function(e){e.forEach(function(e){v+=h(e)})},b=function(e){e.forEach(function(e){v+=p(e)})};m.base.length!==0&&g(m.base);if(m.media.length!==0){s("\nProcessed media queries:");y(m.media.blank);y(m.media.minWidth);y(m.media.minHeight);y(m.media.maxWidth);y(m.media.maxHeight);y(m.media.print);s("")}m.keyframes.length!==0&&b(m.keyframes);i.ext&&(a=a.replace(/\.(.*)/,i.ext));v=e.util.normalizelf(v);e.file.write(a,v);e.log.ok("File "+a+" created.")});r&&e.fatal("No files found")})})};